{% extends "base.html" %}

{% block title %}Command Center - Start Your Day{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous" />
<style>
    .command-center {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }

    /* Header */
    .cc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .cc-header h1 {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .cc-header .date-info {
        font-size: 16px;
        color: #6b7280;
    }

    .cc-header .refresh-btn {
        padding: 10px 20px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        color: #374151;
    }

    .cc-header .refresh-btn:hover {
        background: #e5e7eb;
    }

    /* Deadline Banner */
    .deadline-banner {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        color: white;
        padding: 20px 32px;
        border-radius: 12px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .deadline-banner.warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .deadline-banner.normal {
        background: linear-gradient(135deg, #0071ce 0%, #004c91 100%);
    }

    .deadline-banner .info {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .deadline-banner .info i {
        font-size: 32px;
    }

    .deadline-banner .text h2 {
        margin: 0 0 4px 0;
        font-size: 20px;
    }

    .deadline-banner .text p {
        margin: 0;
        opacity: 0.9;
    }

    .deadline-banner .countdown {
        text-align: right;
    }

    .deadline-banner .countdown .time {
        font-size: 42px;
        font-weight: 700;
        font-family: 'SF Mono', monospace;
        letter-spacing: 2px;
    }

    .deadline-banner .countdown .label {
        font-size: 12px;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Quick Stats */
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: center;
        border-top: 4px solid #e5e7eb;
    }

    .stat-card.primary { border-top-color: #0071ce; }
    .stat-card.success { border-top-color: #10b981; }
    .stat-card.warning { border-top-color: #f59e0b; }
    .stat-card.danger { border-top-color: #dc2626; }

    .stat-card .number {
        font-size: 36px;
        font-weight: 700;
        line-height: 1;
    }

    .stat-card.primary .number { color: #0071ce; }
    .stat-card.success .number { color: #10b981; }
    .stat-card.warning .number { color: #f59e0b; }
    .stat-card.danger .number { color: #dc2626; }

    .stat-card .label {
        font-size: 13px;
        color: #6b7280;
        margin-top: 8px;
    }

    /* Main Grid */
    .cc-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    @media (max-width: 1024px) {
        .cc-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Section Cards */
    .cc-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .cc-section-header {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cc-section-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .cc-section-header .count {
        background: #f3f4f6;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 13px;
        color: #6b7280;
    }

    .cc-section-header .view-all {
        font-size: 13px;
        color: #0071ce;
        text-decoration: none;
    }

    .cc-section-header .view-all:hover {
        text-decoration: underline;
    }

    .cc-section-body {
        padding: 16px 20px;
    }

    /* Item Lists */
    .cc-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: background 0.2s;
    }

    .cc-item:hover {
        background: #f3f4f6;
    }

    .cc-item:last-child {
        margin-bottom: 0;
    }

    .cc-item .icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .cc-item .icon.urgent {
        background: #fef2f2;
        color: #dc2626;
    }

    .cc-item .icon.warning {
        background: #fffbeb;
        color: #f59e0b;
    }

    .cc-item .icon.info {
        background: #f0f9ff;
        color: #0071ce;
    }

    .cc-item .icon.success {
        background: #ecfdf5;
        color: #10b981;
    }

    .cc-item .content {
        flex: 1;
        min-width: 0;
    }

    .cc-item .title {
        font-size: 14px;
        font-weight: 500;
        color: #1f2937;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .cc-item .meta {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }

    .cc-item .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .cc-item .badge.urgent {
        background: #fef2f2;
        color: #dc2626;
    }

    .cc-item .badge.warning {
        background: #fffbeb;
        color: #b45309;
    }

    .cc-item .badge.today {
        background: #f0f9ff;
        color: #0071ce;
    }

    .cc-item .action-btn {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        text-decoration: none;
    }

    .cc-item .action-btn.primary {
        background: #0071ce;
        color: white;
    }

    .cc-item .action-btn.secondary {
        background: #f3f4f6;
        color: #374151;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 32px;
        color: #9ca3af;
    }

    .empty-state i {
        font-size: 32px;
        margin-bottom: 8px;
    }

    /* Rotation Cards */
    .rotation-cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .rotation-card {
        background: #f9fafb;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
    }

    .rotation-card .role {
        font-size: 12px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .rotation-card .name {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
    }

    .rotation-card .not-assigned {
        color: #dc2626;
        font-style: italic;
    }

    /* Task checkbox */
    .task-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .task-checkbox:hover {
        border-color: #0071ce;
    }

    /* Priority stripe */
    .cc-item.priority-urgent { border-left: 3px solid #dc2626; }
    .cc-item.priority-high { border-left: 3px solid #f59e0b; }
    .cc-item.priority-normal { border-left: 3px solid #0071ce; }
    .cc-item.priority-low { border-left: 3px solid #9ca3af; }

    /* Responsive */
    @media (max-width: 768px) {
        .command-center {
            padding: 16px;
        }

        .deadline-banner {
            flex-direction: column;
            text-align: center;
            gap: 16px;
        }

        .deadline-banner .countdown {
            text-align: center;
        }

        .quick-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .rotation-cards {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="command-center">
    <!-- Header -->
    <div class="cc-header">
        <div>
            <h1>
                <i class="fas fa-rocket"></i>
                Command Center
            </h1>
            <div class="date-info">
                {{ data.day_of_week }}, {{ data.today }}
            </div>
        </div>
        <button class="refresh-btn" data-action="refresh-command-center">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- Deadline Banner (shown on Fri/Sat/EOM) -->
    {% if data.deadline_info.is_deadline_day %}
    <div class="deadline-banner {{ data.deadline_info.urgency }}">
        <div class="info">
            <i class="fas fa-exclamation-triangle"></i>
            <div class="text">
                <h2>{{ data.deadline_info.reason }} - Scan-Out Deadline</h2>
                <p>All APPROVED events must be scanned out in Walmart by 6:00 PM</p>
            </div>
        </div>
        <div class="countdown">
            <div class="time" id="deadlineTimer">
                {% if data.deadline_info.urgency == 'past_deadline' %}
                PAST DUE
                {% else %}
                --:--:--
                {% endif %}
            </div>
            <div class="label">Time Remaining</div>
        </div>
    </div>
    {% else %}
    <!-- Next deadline info -->
    {% if data.deadline_info.next_deadline %}
    <div class="deadline-banner normal">
        <div class="info">
            <i class="fas fa-calendar-alt"></i>
            <div class="text">
                <h2>Next Deadline: {{ data.deadline_info.next_deadline }}</h2>
                <p>{{ data.deadline_info.days_until_deadline }} days until next scan-out deadline</p>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-card primary">
            <div class="number">{{ data.quick_stats.events_scheduled_today }}</div>
            <div class="label">Scheduled Today</div>
        </div>
        <div class="stat-card {{ 'danger' if data.quick_stats.unscheduled_urgent > 0 else 'success' }}">
            <div class="number">{{ data.quick_stats.unscheduled_urgent }}</div>
            <div class="label">Urgent Unscheduled</div>
        </div>
        <div class="stat-card {{ 'warning' if data.quick_stats.overdue_tasks > 0 else 'success' }}">
            <div class="number">{{ data.quick_stats.pending_tasks }}</div>
            <div class="label">Pending Tasks</div>
        </div>
        <div class="stat-card {{ 'warning' if data.quick_stats.employees_out_today > 0 else 'success' }}">
            <div class="number">{{ data.quick_stats.employees_out_today }}</div>
            <div class="label">Out Today</div>
        </div>
        <div class="stat-card success">
            <div class="number">{{ data.quick_stats.employees_active }}</div>
            <div class="label">Active Employees</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="cc-grid">
        <!-- Left Column -->
        <div>
            <!-- Urgent Events -->
            <div class="cc-section" style="margin-bottom: 24px;">
                <div class="cc-section-header">
                    <h3>
                        <i class="fas fa-fire" style="color: #dc2626;"></i>
                        Urgent Events
                    </h3>
                    <a href="/events" class="view-all">View All Events</a>
                </div>
                <div class="cc-section-body">
                    {% if data.unscheduled_urgent %}
                        {% for event in data.unscheduled_urgent %}
                        <div class="cc-item">
                            <div class="icon {{ event.urgency }}">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <div class="content">
                                <div class="title">{{ event.name }}</div>
                                <div class="meta">{{ event.event_type }} - Due {{ event.due_date }}</div>
                            </div>
                            <span class="badge {{ event.urgency }}">
                                {% if event.days_until_due <= 0 %}
                                Due Today
                                {% elif event.days_until_due == 1 %}
                                Tomorrow
                                {% else %}
                                {{ event.days_until_due }} days
                                {% endif %}
                            </span>
                            <a href="/schedule/{{ event.event_id }}" class="action-btn primary">Schedule</a>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <div>No urgent events - you're on track!</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Tasks & Reminders -->
            <div class="cc-section">
                <div class="cc-section-header">
                    <h3>
                        <i class="fas fa-tasks" style="color: #0071ce;"></i>
                        Tasks & Reminders
                    </h3>
                    <span class="count">{{ data.pending_tasks|length }}</span>
                </div>
                <div class="cc-section-body">
                    {% if data.pending_tasks %}
                        {% for task in data.pending_tasks %}
                        <div class="cc-item priority-{{ task.priority }}" data-task-id="{{ task.id }}">
                            <div class="task-checkbox" data-action="complete-task" data-task-id="{{ task.id }}"></div>
                            <div class="content">
                                <div class="title">{{ task.title }}</div>
                                <div class="meta">
                                    <i class="{{ task.type_icon }}"></i> {{ task.display_type }}
                                    {% if task.due_date %}
                                    - Due: {{ task.due_date }}
                                    {% endif %}
                                </div>
                            </div>
                            {% if task.is_overdue %}
                            <span class="badge urgent">Overdue</span>
                            {% elif task.is_due_today %}
                            <span class="badge today">Today</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-clipboard-check"></i>
                            <div>No pending tasks</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div>
            <!-- Today's Rotation -->
            <div class="cc-section" style="margin-bottom: 24px;">
                <div class="cc-section-header">
                    <h3>
                        <i class="fas fa-users" style="color: #10b981;"></i>
                        Today's Rotation
                    </h3>
                    <a href="/rotations" class="view-all">Manage Rotations</a>
                </div>
                <div class="cc-section-body">
                    <div class="rotation-cards">
                        <div class="rotation-card">
                            <div class="role">Juicer</div>
                            {% if data.rotation_info.juicer %}
                            <div class="name">{{ data.rotation_info.juicer.name }}</div>
                            {% else %}
                            <div class="name not-assigned">Not Assigned</div>
                            {% endif %}
                        </div>
                        <div class="rotation-card">
                            <div class="role">Primary Lead</div>
                            {% if data.rotation_info.primary_lead %}
                            <div class="name">{{ data.rotation_info.primary_lead.name }}</div>
                            {% else %}
                            <div class="name not-assigned">Not Assigned</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employee Issues -->
            <div class="cc-section" style="margin-bottom: 24px;">
                <div class="cc-section-header">
                    <h3>
                        <i class="fas fa-user-clock" style="color: #f59e0b;"></i>
                        Employee Availability
                    </h3>
                    <a href="/time-off" class="view-all">View All</a>
                </div>
                <div class="cc-section-body">
                    {% if data.employee_issues.out_today %}
                        {% for emp in data.employee_issues.out_today %}
                        <div class="cc-item">
                            <div class="icon warning">
                                <i class="fas fa-user-minus"></i>
                            </div>
                            <div class="content">
                                <div class="title">{{ emp.name }}</div>
                                <div class="meta">
                                    Off: {{ emp.start_date }} - {{ emp.end_date }}
                                    {% if emp.reason %}({{ emp.reason }}){% endif %}
                                </div>
                            </div>
                            <span class="badge warning">Out Today</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-thumbs-up"></i>
                            <div>Everyone is available today!</div>
                        </div>
                    {% endif %}

                    {% if data.employee_issues.out_this_week %}
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">UPCOMING THIS WEEK</div>
                        {% for emp in data.employee_issues.out_this_week %}
                        <div class="cc-item">
                            <div class="icon info">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="content">
                                <div class="title">{{ emp.name }}</div>
                                <div class="meta">{{ emp.start_date }} - {{ emp.end_date }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Employee Notes -->
            {% if data.employee_issues.active_notes %}
            <div class="cc-section">
                <div class="cc-section-header">
                    <h3>
                        <i class="fas fa-sticky-note" style="color: #8b5cf6;"></i>
                        Employee Notes
                    </h3>
                </div>
                <div class="cc-section-body">
                    {% for note in data.employee_issues.active_notes %}
                    <div class="cc-item priority-{{ note.priority }}">
                        <div class="icon info">
                            <i class="{{ note.type_icon }}"></i>
                        </div>
                        <div class="content">
                            <div class="title">{{ note.title }}</div>
                            <div class="meta">{{ note.content[:50] }}{% if note.content|length > 50 %}...{% endif %}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Inventory Alerts -->
            {% if data.inventory_alerts and (data.inventory_alerts.total_out > 0 or data.inventory_alerts.total_low > 0) %}
            <div class="cc-section" style="margin-top: 24px;">
                <div class="cc-section-header">
                    <h3>
                        <i class="fas fa-boxes" style="color: #dc2626;"></i>
                        Inventory Alerts
                    </h3>
                    <a href="/inventory" class="view-all">View Inventory</a>
                </div>
                <div class="cc-section-body">
                    {% if data.inventory_alerts.out_of_stock %}
                        {% for item in data.inventory_alerts.out_of_stock %}
                        <div class="cc-item">
                            <div class="icon urgent">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="content">
                                <div class="title">{{ item.name }}</div>
                                <div class="meta">Completely out of stock!</div>
                            </div>
                            <span class="badge urgent">OUT</span>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if data.inventory_alerts.low_stock %}
                        {% for item in data.inventory_alerts.low_stock %}
                        <div class="cc-item">
                            <div class="icon warning">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="content">
                                <div class="title">{{ item.name }}</div>
                                <div class="meta">{{ item.current_quantity }} {{ item.unit }} remaining (threshold: {{ item.reorder_threshold }})</div>
                            </div>
                            <span class="badge warning">LOW</span>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if data.inventory_alerts.total_out > 5 or data.inventory_alerts.total_low > 5 %}
                    <div class="text-center mt-3">
                        <a href="/inventory" class="btn btn-sm btn-outline-primary">
                            View All {{ data.inventory_alerts.total_out + data.inventory_alerts.total_low }} Items
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Deadline countdown timer
{% if data.deadline_info.is_deadline_day and data.deadline_info.urgency != 'past_deadline' %}
(function() {
    const deadline = new Date();
    deadline.setHours(18, 0, 0, 0); // 6 PM today

    function updateTimer() {
        const now = new Date();
        let diff = deadline - now;

        if (diff <= 0) {
            document.getElementById('deadlineTimer').textContent = 'PAST DUE';
            document.querySelector('.deadline-banner').classList.remove('warning', 'normal');
            document.querySelector('.deadline-banner').classList.add('urgent');
            return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        document.getElementById('deadlineTimer').textContent =
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // Update urgency class
        const banner = document.querySelector('.deadline-banner');
        if (hours < 1) {
            banner.classList.remove('warning', 'normal');
            banner.classList.add('urgent');
        } else if (hours < 3) {
            banner.classList.remove('urgent', 'normal');
            banner.classList.add('warning');
        }
    }

    updateTimer();
    setInterval(updateTimer, 1000);
})();
{% endif %}

// Refresh command center
function refreshCommandCenter() {
    location.reload();
}

// Delegated click handler for data-action buttons
document.addEventListener('click', function(e) {
    var target = e.target.closest('[data-action]');
    if (!target) return;
    var action = target.dataset.action;
    switch (action) {
        case 'refresh-command-center':
            refreshCommandCenter();
            break;
        case 'complete-task':
            completeTask(parseInt(target.dataset.taskId));
            break;
    }
});

// Complete task
async function completeTask(taskId) {
    try {
        const response = await fetch(`/api/notes/${taskId}/complete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        });

        const data = await response.json();
        if (data.success) {
            // Animate and remove the task item
            const item = document.querySelector(`[data-task-id="${taskId}"]`);
            if (item) {
                item.style.opacity = '0.5';
                item.style.textDecoration = 'line-through';
                setTimeout(() => item.remove(), 500);
            }
        }
    } catch (error) {
        console.error('Failed to complete task:', error);
    }
}
</script>
{% endblock %}
