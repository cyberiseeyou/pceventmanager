<!-- Quick Note Widget - Add notes/tasks from any page -->
<style>
    /* Quick Note Button */
    #quickNoteBtn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        border-radius: 28px;
        background: linear-gradient(135deg, #0071ce 0%, #004c91 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 113, 206, 0.4);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        z-index: 1000;
        transition: all 0.2s ease;
    }

    #quickNoteBtn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 113, 206, 0.5);
    }

    #quickNoteBtn .badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #dc2626;
        color: white;
        font-size: 12px;
        font-weight: 700;
        min-width: 20px;
        height: 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
    }

    /* Quick Note Modal */
    #quickNoteModal {
        display: none;
        position: fixed;
        bottom: 90px;
        right: 24px;
        width: 380px;
        max-height: calc(100vh - 120px);
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        overflow: hidden;
    }

    #quickNoteModal.show {
        display: flex;
        flex-direction: column;
    }

    .quick-note-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #0071ce 0%, #004c91 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .quick-note-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }

    .quick-note-header .close-btn {
        background: none;
        border: none;
        color: white;
        opacity: 0.8;
        cursor: pointer;
        font-size: 18px;
    }

    .quick-note-header .close-btn:hover {
        opacity: 1;
    }

    /* Tabs */
    .quick-note-tabs {
        display: flex;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }

    .quick-note-tabs button {
        flex: 1;
        padding: 12px;
        background: none;
        border: none;
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .quick-note-tabs button.active {
        color: #0071ce;
        border-bottom-color: #0071ce;
    }

    /* Form Section */
    .quick-note-form {
        padding: 16px 20px;
        display: none;
    }

    .quick-note-form.active {
        display: block;
    }

    .quick-note-form input,
    .quick-note-form textarea,
    .quick-note-form select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        margin-bottom: 12px;
        box-sizing: border-box;
    }

    .quick-note-form input:focus,
    .quick-note-form textarea:focus,
    .quick-note-form select:focus {
        outline: none;
        border-color: #0071ce;
        box-shadow: 0 0 0 3px rgba(0, 113, 206, 0.1);
    }

    .quick-note-form textarea {
        resize: vertical;
        min-height: 60px;
    }

    .quick-note-form label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 4px;
    }

    .form-row {
        display: flex;
        gap: 12px;
    }

    .form-row > div {
        flex: 1;
    }

    .quick-note-form .btn-submit {
        width: 100%;
        padding: 12px;
        background: #0071ce;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
    }

    .quick-note-form .btn-submit:hover {
        background: #005ea6;
    }

    /* Notes List */
    .quick-note-list {
        padding: 12px 16px;
        overflow-y: auto;
        max-height: 300px;
        display: none;
    }

    .quick-note-list.active {
        display: block;
    }

    .note-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 10px 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }

    .note-item:hover {
        background: #f3f4f6;
    }

    .note-item.completed {
        opacity: 0.6;
    }

    .note-item .checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        cursor: pointer;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 2px;
    }

    .note-item .checkbox:hover {
        border-color: #0071ce;
    }

    .note-item.completed .checkbox {
        background: #10b981;
        border-color: #10b981;
    }

    .note-item.completed .checkbox::after {
        content: '\\2713';
        color: white;
        font-size: 12px;
    }

    .note-item .content {
        flex: 1;
        min-width: 0;
    }

    .note-item .title {
        font-size: 14px;
        color: #1f2937;
        line-height: 1.4;
    }

    .note-item.completed .title {
        text-decoration: line-through;
    }

    .note-item .meta {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
        display: flex;
        gap: 8px;
    }

    .note-item .meta .due-date {
        color: #dc2626;
    }

    .note-item .meta .due-date.today {
        color: #f59e0b;
    }

    .note-item .delete-btn {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .note-item:hover .delete-btn {
        opacity: 1;
    }

    .note-item .delete-btn:hover {
        color: #dc2626;
    }

    /* Empty state */
    .notes-empty {
        text-align: center;
        padding: 24px;
        color: #6b7280;
    }

    .notes-empty i {
        font-size: 32px;
        margin-bottom: 8px;
        opacity: 0.5;
    }

    /* Priority indicators */
    .priority-urgent { border-left: 3px solid #dc2626; }
    .priority-high { border-left: 3px solid #f59e0b; }
    .priority-normal { border-left: 3px solid #0071ce; }
    .priority-low { border-left: 3px solid #6b7280; }

    /* Responsive */
    @media (max-width: 480px) {
        #quickNoteModal {
            width: calc(100vw - 48px);
            left: 24px;
            right: 24px;
        }
    }
</style>

<!-- Floating Button -->
<button id="quickNoteBtn" onclick="toggleQuickNote()" title="Add Note / View Tasks">
    <i class="fas fa-sticky-note"></i>
    <span class="badge" id="pendingNotesBadge" style="display: none;">0</span>
</button>

<!-- Quick Note Modal -->
<div id="quickNoteModal">
    <div class="quick-note-header">
        <h3><i class="fas fa-sticky-note"></i> Quick Notes</h3>
        <button class="close-btn" onclick="toggleQuickNote()"><i class="fas fa-times"></i></button>
    </div>

    <div class="quick-note-tabs">
        <button class="active" onclick="switchQuickNoteTab('add')">
            <i class="fas fa-plus"></i> Add
        </button>
        <button onclick="switchQuickNoteTab('pending')">
            <i class="fas fa-list"></i> Pending
        </button>
        <button onclick="switchQuickNoteTab('completed')">
            <i class="fas fa-check"></i> Done
        </button>
    </div>

    <!-- Add Note Form -->
    <div id="quickNoteFormTab" class="quick-note-form active">
        <input type="text" id="quickNoteTitle" placeholder="What do you need to remember?">

        <textarea id="quickNoteContent" placeholder="Details (optional)..." rows="2"></textarea>

        <div class="form-row">
            <div>
                <label>Type</label>
                <select id="quickNoteType">
                    <option value="task">Task</option>
                    <option value="employee">Employee Note</option>
                    <option value="event">Event Note</option>
                    <option value="followup">Follow-up</option>
                    <option value="management">Management</option>
                </select>
            </div>
            <div>
                <label>Priority</label>
                <select id="quickNotePriority">
                    <option value="normal">Normal</option>
                    <option value="low">Low</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div>
                <label>Due Date</label>
                <input type="date" id="quickNoteDueDate">
            </div>
            <div>
                <label>Time</label>
                <input type="time" id="quickNoteDueTime">
            </div>
        </div>

        <button class="btn-submit" onclick="submitQuickNote()">
            <i class="fas fa-save"></i> Save Note
        </button>
    </div>

    <!-- Pending Notes List -->
    <div id="quickNotePendingTab" class="quick-note-list">
        <!-- Populated by JavaScript -->
    </div>

    <!-- Completed Notes List -->
    <div id="quickNoteCompletedTab" class="quick-note-list">
        <!-- Populated by JavaScript -->
    </div>
</div>

<script>
// Quick Note Widget State
let quickNoteOpen = false;
let quickNoteCurrentTab = 'add';
let quickNotes = { pending: [], completed: [] };

// Toggle quick note modal
function toggleQuickNote() {
    quickNoteOpen = !quickNoteOpen;
    const modal = document.getElementById('quickNoteModal');

    if (quickNoteOpen) {
        modal.classList.add('show');
        loadQuickNotes();
        document.getElementById('quickNoteTitle').focus();
    } else {
        modal.classList.remove('show');
    }
}

// Switch tabs
function switchQuickNoteTab(tab) {
    quickNoteCurrentTab = tab;

    // Update tab buttons
    document.querySelectorAll('.quick-note-tabs button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // Show correct content
    document.getElementById('quickNoteFormTab').classList.remove('active');
    document.getElementById('quickNotePendingTab').classList.remove('active');
    document.getElementById('quickNoteCompletedTab').classList.remove('active');

    if (tab === 'add') {
        document.getElementById('quickNoteFormTab').classList.add('active');
    } else if (tab === 'pending') {
        document.getElementById('quickNotePendingTab').classList.add('active');
        renderQuickNotesList('pending');
    } else if (tab === 'completed') {
        document.getElementById('quickNoteCompletedTab').classList.add('active');
        renderQuickNotesList('completed');
    }
}

// Load notes from API
async function loadQuickNotes() {
    try {
        // Load pending
        const pendingRes = await fetch('/api/notes/?completed=false&limit=20');
        const pendingData = await pendingRes.json();
        if (pendingData.success) {
            quickNotes.pending = pendingData.notes;
            updatePendingBadge(pendingData.notes.length);
        }

        // Load completed (last 10)
        const completedRes = await fetch('/api/notes/?completed=true&limit=10');
        const completedData = await completedRes.json();
        if (completedData.success) {
            quickNotes.completed = completedData.notes;
        }

        // Render current tab
        if (quickNoteCurrentTab !== 'add') {
            renderQuickNotesList(quickNoteCurrentTab);
        }
    } catch (error) {
        console.error('Failed to load notes:', error);
    }
}

// Update pending badge
function updatePendingBadge(count) {
    const badge = document.getElementById('pendingNotesBadge');
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

// Render notes list
function renderQuickNotesList(listType) {
    const container = document.getElementById(listType === 'pending' ? 'quickNotePendingTab' : 'quickNoteCompletedTab');
    const notes = quickNotes[listType];

    if (notes.length === 0) {
        container.innerHTML = `
            <div class="notes-empty">
                <i class="fas fa-${listType === 'pending' ? 'check-circle' : 'clipboard-list'}"></i>
                <div>${listType === 'pending' ? 'No pending tasks!' : 'No completed tasks'}</div>
            </div>
        `;
        return;
    }

    container.innerHTML = notes.map(note => `
        <div class="note-item priority-${note.priority} ${note.is_completed ? 'completed' : ''}" data-id="${note.id}">
            <div class="checkbox" onclick="toggleNoteComplete(${note.id}, ${!note.is_completed})"></div>
            <div class="content">
                <div class="title">${escapeHtml(note.title)}</div>
                <div class="meta">
                    <span><i class="${note.type_icon}"></i> ${note.display_type}</span>
                    ${note.due_date ? `<span class="due-date ${note.is_due_today ? 'today' : ''}">${formatNoteDate(note.due_date)}</span>` : ''}
                </div>
            </div>
            <button class="delete-btn" onclick="deleteQuickNote(${note.id})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

// Submit new note
async function submitQuickNote() {
    const title = document.getElementById('quickNoteTitle').value.trim();
    if (!title) {
        alert('Please enter a note title');
        return;
    }

    const noteData = {
        title: title,
        content: document.getElementById('quickNoteContent').value.trim(),
        note_type: document.getElementById('quickNoteType').value,
        priority: document.getElementById('quickNotePriority').value,
        due_date: document.getElementById('quickNoteDueDate').value || null,
        due_time: document.getElementById('quickNoteDueTime').value || null
    };

    try {
        const response = await fetch('/api/notes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify(noteData)
        });

        const data = await response.json();
        if (data.success) {
            // Clear form
            document.getElementById('quickNoteTitle').value = '';
            document.getElementById('quickNoteContent').value = '';
            document.getElementById('quickNoteDueDate').value = '';
            document.getElementById('quickNoteDueTime').value = '';
            document.getElementById('quickNoteType').value = 'task';
            document.getElementById('quickNotePriority').value = 'normal';

            // Reload notes
            loadQuickNotes();

            // Show success briefly
            showQuickNoteToast('Note saved!');
        } else {
            alert(data.error || 'Failed to save note');
        }
    } catch (error) {
        console.error('Failed to save note:', error);
        alert('Failed to save note');
    }
}

// Toggle note completion
async function toggleNoteComplete(noteId, complete) {
    try {
        const endpoint = complete ? 'complete' : 'reopen';
        const response = await fetch(`/api/notes/${noteId}/${endpoint}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });

        const data = await response.json();
        if (data.success) {
            loadQuickNotes();
        }
    } catch (error) {
        console.error('Failed to update note:', error);
    }
}

// Delete note
async function deleteQuickNote(noteId) {
    if (!confirm('Delete this note?')) return;

    try {
        const response = await fetch(`/api/notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });

        const data = await response.json();
        if (data.success) {
            loadQuickNotes();
        }
    } catch (error) {
        console.error('Failed to delete note:', error);
    }
}

// Helper: Get CSRF token
function getCSRFToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

// Helper: Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper: Format date
function formatNoteDate(dateStr) {
    const date = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const noteDate = new Date(dateStr);
    noteDate.setHours(0, 0, 0, 0);

    if (noteDate.getTime() === today.getTime()) {
        return 'Today';
    }

    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    if (noteDate.getTime() === tomorrow.getTime()) {
        return 'Tomorrow';
    }

    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// Helper: Show toast notification
function showQuickNoteToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 160px;
        right: 24px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 1002;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

// Load pending count on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load pending count for badge
    fetch('/api/notes/?completed=false&limit=100')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updatePendingBadge(data.notes.length);
            }
        })
        .catch(err => console.error('Failed to load notes count:', err));
});
</script>
