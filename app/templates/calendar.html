{#
  Template: calendar.html
  Route: main.calendar_view (GET /calendar)

  Context variables:
    selected_date          (date)       - Currently selected date
    events_by_date         (dict)       - {date_str: [event_dicts]} events grouped by date
    event_counts_by_date   (dict)       - {date_str: int} event count per date
    unscheduled_by_date    (dict)       - {date_str: int} unscheduled event count per date
#}
{% extends "base.html" %}

{% block title %}Calendar - Product Connections Scheduler{% endblock %}
{% block page_title %}Calendar{% endblock %}

{% block extra_head %}
<style>
    .calendar-container {
        width: 100%;
        margin: 0;
        padding: 0;
    }
    
    .calendar-header {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-md);
        background: var(--bg-secondary);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(46, 76, 115, 0.1);
        position: relative;
    }

    .calendar-nav {
        position: absolute;
        left: var(--spacing-md);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .month-nav {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .month-title {
        font-size: var(--font-size-h2);
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
        margin: 0;
        min-width: 200px;
        text-align: center;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        background: rgba(46, 76, 115, 0.1);
        border-radius: var(--border-radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }
    
    .calendar-day-header {
        background: var(--pc-navy);
        color: var(--text-white);
        padding: var(--spacing-sm);
        text-align: center;
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-small);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .calendar-day {
        background: var(--bg-primary);
        min-height: 140px;
        padding: var(--spacing-xs);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        border: 2px solid transparent;
        display: flex;
        flex-direction: column;
    }
    
    .calendar-day:hover {
        background: var(--bg-secondary);
        border-color: var(--secondary-color);
    }
    
    .calendar-day.other-month {
        background: var(--bg-tertiary);
        opacity: 0.5;
    }
    
    .calendar-day.today {
        border-color: var(--primary-color);
        background: rgba(46, 76, 115, 0.05);
    }
    
    .calendar-day.has-events {
        background: rgba(27, 155, 216, 0.1);
    }
    
    .day-number {
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
        font-size: 1.1rem;
    }

    .day-events {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 4px;
        padding: 4px 0;
    }

    .event-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius-sm);
        font-size: 0.75rem;
        font-weight: var(--font-weight-bold);
        color: var(--text-white);
        padding: 4px;
        min-height: 28px;
        position: relative;
    }

    .event-badge.badge-core {
        background: #dc3545;
    }

    .event-badge.badge-juicer {
        background: #28a745;
    }

    .event-badge.badge-supervisor {
        background: #6610f2;
    }

    .event-badge.badge-freeosk {
        background: #fd7e14;
    }

    .event-badge.badge-digitals {
        background: #007bff;
    }

    .event-badge.badge-other {
        background: #6c757d;
    }

    .event-badge.empty {
        background: transparent;
        border: 1px dashed rgba(46, 76, 115, 0.2);
        color: transparent;
    }

    .badge-reissued {
        background: #DBEAFE;
        color: #1E40AF;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .unscheduled-warning {
        position: absolute;
        top: 4px;
        right: 4px;
        font-size: 1.2rem;
        color: #ffc107;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
        z-index: 10;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .unscheduled-warning:hover {
        transform: scale(1.2);
    }

    /* Lock indicator on calendar days */
    .lock-indicator {
        position: absolute;
        top: 4px;
        left: 4px;
        font-size: 1rem;
        color: #dc3545;
        text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
        z-index: 10;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .lock-indicator:hover {
        transform: scale(1.2);
    }

    .calendar-day.is-locked {
        background: rgba(220, 53, 69, 0.08);
        border-color: rgba(220, 53, 69, 0.3);
    }

    .calendar-day.is-locked:hover {
        border-color: #dc3545;
    }
    
    /* Day Detail Modal */
    .day-detail-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .day-detail-content {
        background: var(--bg-primary);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-xl);
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        position: relative;
    }
    
    .modal-close {
        position: absolute;
        top: var(--spacing-md);
        right: var(--spacing-md);
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-close:hover {
        color: var(--text-primary);
    }
    
    .day-detail-header {
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--pc-light-blue);
    }
    
    .day-detail-title {
        font-size: var(--font-size-h2);
        color: var(--text-primary);
        margin: 0;
    }
    
    .day-events-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }
    
    .day-event-card {
        background: var(--bg-secondary);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        border-left: 4px solid var(--secondary-color);
    }
    
    .event-time {
        font-weight: var(--font-weight-bold);
        color: var(--primary-color);
        font-size: var(--font-size-small);
    }
    
    .event-name {
        font-weight: var(--font-weight-heading);
        color: var(--text-primary);
        margin: var(--spacing-xs) 0;
    }
    
    .event-details {
        font-size: var(--font-size-small);
        color: var(--text-muted);
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
    }
    
    .no-events {
        text-align: center;
        color: var(--text-muted);
        font-style: italic;
        padding: var(--spacing-xl);
    }
    
    .loading {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--text-muted);
    }
    
    .event-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
        flex-wrap: wrap;
    }
    
    .event-action-btn {
        padding: var(--spacing-xs) var(--spacing-sm);
        border: none;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-small);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-reschedule {
        background: var(--pc-blue);
        color: var(--text-white);
    }
    
    .btn-reschedule:hover {
        background: var(--pc-navy);
    }
    
    .btn-trade {
        background: var(--secondary-color);
        color: var(--text-white);
    }
    
    .btn-trade:hover {
        background: #0fa8ce;
    }
    
    .btn-change-employee {
        background: #28a745;
        color: var(--text-white);
    }

    .btn-change-employee:hover {
        background: #218838;
    }

    .btn-unschedule {
        background: #dc3545;
        color: var(--text-white);
    }

    .btn-unschedule:hover {
        background: #c82333;
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
    }
    
    .action-modal {
        background: var(--bg-primary);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-xl);
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        position: relative;
    }
    
    .action-modal h3 {
        margin-top: 0;
        color: var(--text-primary);
        border-bottom: 2px solid var(--pc-light-blue);
        padding-bottom: var(--spacing-sm);
    }
    
    .form-group {
        margin-bottom: var(--spacing-md);
    }
    
    .form-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
    }
    
    .form-group input, .form-group select {
        width: 100%;
        padding: var(--spacing-sm);
        border: 1px solid #ddd;
        border-radius: var(--border-radius-sm);
        box-sizing: border-box;
    }
    
    .modal-actions {
        display: flex;
        gap: var(--spacing-sm);
        justify-content: flex-end;
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-md);
        border-top: 1px solid #ddd;
    }
    
    .hidden {
        display: none !important;
    }

    /* Calendar Legend */
    .calendar-legend {
        background: var(--bg-primary);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        border: 1px solid rgba(46, 76, 115, 0.1);
        box-shadow: var(--shadow-sm);
    }

    .legend-title {
        font-size: var(--font-size-body);
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
        text-align: center;
    }

    .legend-content {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: var(--spacing-lg);
        flex-wrap: wrap;
    }

    .legend-section {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--font-size-small);
    }

    .legend-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 24px;
        border-radius: var(--border-radius-sm);
        font-size: 0.7rem;
        font-weight: var(--font-weight-bold);
        color: var(--text-white);
        padding: 2px 6px;
    }

    .legend-separator {
        width: 1px;
        height: 24px;
        background: rgba(46, 76, 115, 0.2);
    }

    .legend-symbol {
        font-size: 1.2rem;
    }

    /* Legend Badge Colors */
    .legend-badge.badge-core {
        background: #dc3545;
    }

    .legend-badge.badge-juicer {
        background: #28a745;
    }

    .legend-badge.badge-supervisor {
        background: #6610f2;
    }

    .legend-badge.badge-freeosk {
        background: #fd7e14;
    }

    .legend-badge.badge-digitals {
        background: #007bff;
    }

    .legend-badge.badge-other {
        background: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
    <div class="calendar-container">
        <!-- Calendar Legend -->
        <div class="calendar-legend">
            <div class="legend-title">Calendar Key</div>
            <div class="legend-content">
                <!-- Event Type Badges -->
                <div class="legend-section">
                    <div class="legend-item">
                        <span class="legend-badge badge-core">C</span>
                        <span>Core</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge badge-juicer">J</span>
                        <span>Juicer</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge badge-supervisor">S</span>
                        <span>Supervisor</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge badge-freeosk">F</span>
                        <span>Freeosk</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge badge-digitals">D</span>
                        <span>Digitals</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge badge-other">O</span>
                        <span>Other</span>
                    </div>
                </div>

                <!-- Separator -->
                <div class="legend-separator"></div>

                <!-- Symbols -->
                <div class="legend-section">
                    <div class="legend-item">
                        <span class="legend-symbol">‚ö†Ô∏è</span>
                        <span><strong>Unscheduled Events:</strong> This symbol means there are events that are not scheduled whose due date is on this day. This means that the event must be completed prior to the date with the symbol.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Header -->
        <div class="calendar-header">
            <div class="calendar-nav">
                <button class="btn btn-secondary" data-action="go-today">Today</button>
            </div>
            <div class="month-nav">
                <button class="btn btn-outline" data-action="change-month" data-delta="-1">‚Äπ Previous</button>
                <h2 class="month-title" id="month-title">{{ selected_date.strftime('%B %Y') }}</h2>
                <button class="btn btn-outline" data-action="change-month" data-delta="1">Next ‚Ä∫</button>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid" id="calendar-grid">
            <!-- Day headers -->
            <div class="calendar-day-header">Sun</div>
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>
            
            <!-- Calendar days will be generated by JavaScript -->
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="day-detail-modal" id="day-detail-modal">
        <div class="day-detail-content">
            <button class="modal-close" data-action="close-day-detail">&times;</button>
            <div class="day-detail-header">
                <h2 class="day-detail-title" id="day-detail-title">Loading...</h2>
                
                <!-- Event Statistics -->
                <div class="event-statistics" id="event-statistics" style="margin: var(--spacing-md) 0; padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--border-radius-md); border: 1px solid rgba(46, 76, 115, 0.1);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                        <div class="stat-item">
                            <span class="stat-label" style="font-size: var(--font-size-small); color: var(--text-muted);">Total Core Events:</span>
                            <span class="stat-value" id="total-core" style="font-weight: var(--font-weight-bold); color: var(--pc-blue); font-size: var(--font-size-body);">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" style="font-size: var(--font-size-small); color: var(--text-muted);">Total Digitals:</span>
                            <span class="stat-value" id="total-digitals" style="font-weight: var(--font-weight-bold); color: var(--pc-blue); font-size: var(--font-size-body);">0</span>
                        </div>
                    </div>
                    
                    <div class="core-time-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-sm); border-top: 1px solid rgba(46, 76, 115, 0.1); padding-top: var(--spacing-sm);">
                        <div class="time-stat" style="text-align: center;">
                            <div style="font-size: var(--font-size-small); color: var(--text-muted); margin-bottom: var(--spacing-xs);">9:45 AM</div>
                            <div class="time-count" id="core-945" style="font-weight: var(--font-weight-bold); color: var(--pc-navy); font-size: var(--font-size-body);">0</div>
                        </div>
                        <div class="time-stat" style="text-align: center;">
                            <div style="font-size: var(--font-size-small); color: var(--text-muted); margin-bottom: var(--spacing-xs);">10:30 AM</div>
                            <div class="time-count" id="core-1030" style="font-weight: var(--font-weight-bold); color: var(--pc-navy); font-size: var(--font-size-body);">0</div>
                        </div>
                        <div class="time-stat" style="text-align: center;">
                            <div style="font-size: var(--font-size-small); color: var(--text-muted); margin-bottom: var(--spacing-xs);">11:00 AM</div>
                            <div class="time-count" id="core-1100" style="font-weight: var(--font-weight-bold); color: var(--pc-navy); font-size: var(--font-size-body);">0</div>
                        </div>
                        <div class="time-stat" style="text-align: center;">
                            <div style="font-size: var(--font-size-small); color: var(--text-muted); margin-bottom: var(--spacing-xs);">11:30 AM</div>
                            <div class="time-count" id="core-1130" style="font-weight: var(--font-weight-bold); color: var(--pc-navy); font-size: var(--font-size-body);">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="day-detail-actions" style="margin-top: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                    <div class="event-filters">
                        <label for="event-type-filter" style="margin-right: var(--spacing-sm);">Filter by Event Type:</label>
                        <select id="event-type-filter" data-action="filter-events" style="padding: var(--spacing-xs); border-radius: var(--border-radius-sm);">
                            <option value="all">All Events</option>
                            <option value="Core">Core</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Freeosk">Freeosk</option>
                            <option value="Digitals">Digitals</option>
                            <option value="Other">Other</option>
                            <option value="Juicer">Juicer</option>
                        </select>
                    </div>
                    <div class="action-buttons" style="display: flex; gap: var(--spacing-sm);">
                        <button id="lock-day-btn" class="btn btn-lock" data-action="toggle-day-lock" style="display: flex; align-items: center; gap: var(--spacing-xs);">
                            <span id="modal-lock-icon">üîì</span>
                            <span id="modal-lock-text">Lock Day</span>
                        </button>
                        <button id="print-schedule-btn" class="btn btn-secondary" data-action="print-day-schedule">
                            Print Schedule
                        </button>
                    </div>
                </div>
            </div>
            <div class="day-events-list" id="day-events-list">
                <div class="loading">Loading events...</div>
            </div>
        </div>
    </div>

    <!-- Reschedule Event Modal -->
    <div class="modal-backdrop" id="reschedule-modal">
        <div class="action-modal">
            <button class="modal-close" data-action="close-modal" data-modal="reschedule-modal">&times;</button>
            <h3>Reschedule Event</h3>
            <form id="reschedule-form">
                <input type="hidden" id="reschedule-schedule-id">
                <div class="form-group">
                    <label>Event:</label>
                    <div id="reschedule-event-info"></div>
                </div>
                <div class="form-group">
                    <label for="reschedule-date">New Date:</label>
                    <input type="date" id="reschedule-date" required>
                </div>
                <div class="form-group">
                    <label for="reschedule-time">New Time:</label>
                    <input type="time" id="reschedule-time" required>
                    <select id="reschedule-time-dropdown" class="hidden">
                        <option value="">Select a time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reschedule-employee">Employee:</label>
                    <select id="reschedule-employee" required>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal" data-modal="reschedule-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Reschedule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Trade Events Modal -->
    <div class="modal-backdrop" id="trade-modal">
        <div class="action-modal">
            <button class="modal-close" data-action="close-modal" data-modal="trade-modal">&times;</button>
            <h3>Trade Events</h3>
            <form id="trade-form">
                <input type="hidden" id="trade-schedule-id">
                <div class="form-group">
                    <label>Current Assignment:</label>
                    <div id="trade-current-info"></div>
                </div>
                <div class="form-group">
                    <label for="trade-with-employee">Trade With Employee:</label>
                    <select id="trade-with-employee" required>
                        <option value="">Select employee to trade with...</option>
                    </select>
                </div>
                <div id="trade-preview" class="form-group hidden">
                    <label>After Trade:</label>
                    <div id="trade-preview-info"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal" data-modal="trade-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Trade Events</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Employee Modal -->
    <div class="modal-backdrop" id="change-employee-modal">
        <div class="action-modal">
            <button class="modal-close" data-action="close-modal" data-modal="change-employee-modal">&times;</button>
            <h3>Change Employee</h3>
            <form id="change-employee-form">
                <input type="hidden" id="change-schedule-id">
                <div class="form-group">
                    <label>Event Details:</label>
                    <div id="change-event-info"></div>
                </div>
                <div class="form-group">
                    <label for="change-new-employee">New Employee:</label>
                    <select id="change-new-employee" required>
                        <option value="">Select new employee...</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal" data-modal="change-employee-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Employee</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // XSS protection: escape dynamic values before inserting into innerHTML
    function escapeHtml(text) {
        if (text == null) return '';
        return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    let currentDate = new Date('{{ selected_date.strftime('%Y-%m-%d') }}');
    let eventsData = {{ events_by_date | tojson }};
    let eventCountsData = {{ event_counts_by_date | tojson }};
    let unscheduledData = {{ unscheduled_by_date | tojson }};
    let lockedDaysData = {};  // Will be populated by loadLockedDays
    let currentModalDate = null;  // Track current modal date for lock toggle
    let currentModalLocked = false;  // Track current modal lock state

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', async function() {
        await loadLockedDays();
        generateCalendar();
    });

    /**
     * Load locked days for the current month range
     */
    async function loadLockedDays() {
        try {
            // Get date range for the calendar view (includes days from prev/next month)
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 42);

            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];

            const response = await fetch(`/api/locked-days?start_date=${startStr}&end_date=${endStr}`);
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.locked_days) {
                    lockedDaysData = {};
                    data.locked_days.forEach(ld => {
                        lockedDaysData[ld.date] = ld;
                    });
                }
            }
        } catch (error) {
            console.error('Error loading locked days:', error);
        }
    }
    
    function generateCalendar() {
        const grid = document.getElementById('calendar-grid');
        const monthTitle = document.getElementById('month-title');
        
        // Update month title
        monthTitle.textContent = currentDate.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
        });
        
        // Clear existing days (keep headers)
        const days = grid.querySelectorAll('.calendar-day');
        days.forEach(day => day.remove());
        
        // Get first day of month and number of days
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        // Generate 42 days (6 weeks)
        for (let i = 0; i < 42; i++) {
            const dayDate = new Date(startDate);
            dayDate.setDate(startDate.getDate() + i);
            
            const dayStr = dayDate.toISOString().split('T')[0];
            const isCurrentMonth = dayDate.getMonth() === currentDate.getMonth();
            const isToday = dayStr === todayStr;
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.dataset.date = dayStr;
            
            if (!isCurrentMonth) {
                dayElement.classList.add('other-month');
            }
            if (isToday) {
                dayElement.classList.add('today');
            }
            
            // Check if day has events
            const dayEvents = eventsData[dayStr] || [];
            const eventCounts = eventCountsData[dayStr] || {
                'Core': 0, 'Juicer': 0, 'Supervisor': 0,
                'Freeosk': 0, 'Digitals': 0, 'Other': 0
            };
            const unscheduledCount = unscheduledData[dayStr] || 0;

            if (dayEvents.length > 0) {
                dayElement.classList.add('has-events');
            }

            // Build badge grid HTML
            const badges = [
                { label: 'C', count: eventCounts.Core, class: 'badge-core' },
                { label: 'S', count: eventCounts.Supervisor, class: 'badge-supervisor' },
                { label: 'J', count: eventCounts.Juicer, class: 'badge-juicer' },
                { label: 'F', count: eventCounts.Freeosk, class: 'badge-freeosk' },
                { label: 'D', count: eventCounts.Digitals, class: 'badge-digitals' },
                { label: 'O', count: eventCounts.Other, class: 'badge-other' }
            ];

            const badgesHtml = badges.map(badge => {
                const isEmpty = badge.count === 0;
                const classes = isEmpty ? 'event-badge empty' : `event-badge ${badge.class}`;
                const content = isEmpty ? '' : `${badge.label} | ${badge.count}`;
                return `<div class="${classes}">${content}</div>`;
            }).join('');

            // Check if day is locked
            const isLocked = lockedDaysData[dayStr] !== undefined;
            if (isLocked) {
                dayElement.classList.add('is-locked');
            }

            dayElement.innerHTML = `
                ${isLocked ? `<div class="lock-indicator" data-date="${dayStr}" title="Day is locked: ${escapeHtml(lockedDaysData[dayStr]?.reason || 'No reason provided')}">üîí</div>` : ''}
                ${unscheduledCount > 0 ? `<div class="unscheduled-warning" data-date="${dayStr}" title="${unscheduledCount} unscheduled event(s)">‚ö†Ô∏è</div>` : ''}
                <div class="day-number">${dayDate.getDate()}</div>
                <div class="day-events">
                    ${badgesHtml}
                </div>
            `;

            // Add click handler for the warning symbol if it exists
            if (unscheduledCount > 0) {
                const warningSymbol = dayElement.querySelector('.unscheduled-warning');
                warningSymbol.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent day click event
                    const date = this.dataset.date;
                    window.location.href = `/unscheduled?due_date=${date}`;
                });
            }

            dayElement.addEventListener('click', function() {
                window.location.href = `/schedule/daily/${dayStr}`;
            });
            
            grid.appendChild(dayElement);
        }
    }
    
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        // Reload with new month
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('date', currentDate.toISOString().split('T')[0]);
        window.location.href = newUrl.toString();
    }
    
    function goToToday() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        window.location.href = `/schedule/daily/${todayStr}`;
    }
    
    function showDayDetail(dateStr) {
        const modal = document.getElementById('day-detail-modal');
        const title = document.getElementById('day-detail-title');
        const eventsList = document.getElementById('day-events-list');

        modal.style.display = 'flex';
        title.textContent = 'Loading...';
        eventsList.innerHTML = '<div class="loading">Loading events...</div>';

        // Track current modal date for lock functionality
        currentModalDate = dateStr;
        currentModalLocked = lockedDaysData[dateStr] !== undefined;
        updateModalLockButton();

        // Fetch day events
        fetch(`/calendar/day/${dateStr}`)
            .then(response => response.json())
            .then(data => {
                // Store the current day's data for printing
                currentDayData = data;

                // Build title with Primary Lead and Juicer info
                let titleHtml = `<div>${escapeHtml(data.formatted_date)}</div>`;
                if (data.primary_lead || data.juicer) {
                    titleHtml += '<div style="font-size: 0.9rem; color: var(--text-muted); margin-top: var(--spacing-xs);">';
                    if (data.primary_lead) {
                        titleHtml += `<span style="margin-right: var(--spacing-md);">üëî Primary Lead: <strong>${escapeHtml(data.primary_lead)}</strong></span>`;
                    }
                    if (data.juicer) {
                        titleHtml += `<span>üßÉ Juicer: <strong>${escapeHtml(data.juicer)}</strong></span>`;
                    }
                    titleHtml += '</div>';
                }
                title.innerHTML = titleHtml;

                // Update event statistics
                updateEventStatistics(data.events);

                if (data.events.length === 0) {
                    eventsList.innerHTML = '<div class="no-events">No events scheduled for this day</div>';
                } else {
                    eventsList.innerHTML = data.events.map(event => `
                        <div class="day-event-card" data-event-type="${escapeHtml(event.event_type)}">
                            <div class="event-time">${escapeHtml(event.time)}</div>
                            <div class="event-name">${escapeHtml(event.event_name)}</div>
                            <div class="event-details">
                                <span class="event-type-badge event-type-${escapeHtml(event.event_type.toLowerCase().replace(/ /g, '-'))}">${escapeHtml(event.event_type)}</span>
                                ${event.is_reissued ? '<span class="badge-reissued">üîÑ REISSUED</span>' : ''}
                                <span>üë§ ${escapeHtml(event.employee_name)}</span>
                                ${event.store_name ? `<span>üè™ ${escapeHtml(event.store_name)}</span>` : ''}
                                ${event.estimated_time ? `<span>‚è±Ô∏è ${escapeHtml(event.estimated_time)} min</span>` : ''}
                                ${event.supervisor_name ? `<span style="color: #6610f2; font-weight: bold;">üë®‚Äçüíº Supervisor: ${escapeHtml(event.supervisor_name)} (${escapeHtml(event.supervisor_time)})</span>` : ''}
                            </div>
                            <div class="event-dates" style="font-size: var(--font-size-small); color: var(--text-muted); margin-top: var(--spacing-xs); display: flex; gap: var(--spacing-md);">
                                <span>üìÖ Start: ${escapeHtml(event.start_date)}</span>
                                <span>üìÖ Due: ${escapeHtml(event.due_date)}</span>
                            </div>
                            <div class="event-actions">
                                <button class="event-action-btn btn-reschedule"
                                        data-schedule-id="${escapeHtml(event.id)}"
                                        data-event-name="${escapeHtml(event.event_name)}"
                                        data-event-type="${escapeHtml(event.event_type)}"
                                        data-time="${escapeHtml(event.time)}"
                                        data-employee-name="${escapeHtml(event.employee_name)}"
                                        data-employee-id="${escapeHtml(event.employee_id)}"
                                        data-date="${escapeHtml(data.date)}">
                                    Reschedule
                                </button>
                                ${event.event_type === 'Core' ? `
                                    <button class="event-action-btn btn-trade"
                                            data-schedule-id="${escapeHtml(event.id)}"
                                            data-event-name="${escapeHtml(event.event_name)}"
                                            data-employee-name="${escapeHtml(event.employee_name)}"
                                            data-time="${escapeHtml(event.time)}"
                                            data-date="${escapeHtml(data.date)}">
                                        Trade
                                    </button>
                                ` : ''}
                                <button class="event-action-btn btn-change-employee"
                                        data-schedule-id="${escapeHtml(event.id)}"
                                        data-event-name="${escapeHtml(event.event_name)}"
                                        data-event-type="${escapeHtml(event.event_type)}"
                                        data-time="${escapeHtml(event.time)}"
                                        data-employee-name="${escapeHtml(event.employee_name)}"
                                        data-date="${escapeHtml(data.date)}">
                                    Change Employee
                                </button>
                                <button class="event-action-btn btn-unschedule"
                                        data-schedule-id="${escapeHtml(event.id)}"
                                        data-event-name="${escapeHtml(event.event_name)}"
                                        data-employee-name="${escapeHtml(event.employee_name)}">
                                    Unschedule
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add event listeners for the action buttons
                    setupEventActionListeners();
                }
            })
            .catch(error => {
                console.error('Error loading day events:', error);
                eventsList.innerHTML = '<div class="no-events">Error loading events</div>';
            });
    }
    
    function updateEventStatistics(events) {
        // Initialize counters
        let totalCore = 0;
        let totalDigitals = 0;
        let core945 = 0;
        let core1030 = 0;
        let core1100 = 0;
        let core1130 = 0;
        
        // Count events by type and Core events by time
        events.forEach(event => {
            if (event.event_type === 'Core') {
                totalCore++;
                
                // Convert time to check against Core time slots
                const time24 = convertTo24Hour(event.time);
                switch(time24) {
                    case '09:45':
                        core945++;
                        break;
                    case '10:30':
                        core1030++;
                        break;
                    case '11:00':
                        core1100++;
                        break;
                    case '11:30':
                        core1130++;
                        break;
                }
            } else if (event.event_type === 'Digitals') {
                totalDigitals++;
            }
        });
        
        // Update the display
        document.getElementById('total-core').textContent = totalCore;
        document.getElementById('total-digitals').textContent = totalDigitals;
        document.getElementById('core-945').textContent = core945;
        document.getElementById('core-1030').textContent = core1030;
        document.getElementById('core-1100').textContent = core1100;
        document.getElementById('core-1130').textContent = core1130;
    }
    
    function setupEventActionListeners() {
        // Add event listeners for reschedule buttons
        document.querySelectorAll('.btn-reschedule').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const scheduleId = this.dataset.scheduleId;
                const eventName = this.dataset.eventName;
                const eventType = this.dataset.eventType;
                const time = this.dataset.time;
                const employeeName = this.dataset.employeeName;
                const employeeId = this.dataset.employeeId;
                const date = this.dataset.date;

                openRescheduleModal(scheduleId, eventName, eventType, time, employeeName, employeeId, date);
            });
        });
        
        // Add event listeners for change employee buttons
        document.querySelectorAll('.btn-change-employee').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const scheduleId = this.dataset.scheduleId;
                const eventName = this.dataset.eventName;
                const eventType = this.dataset.eventType;
                const time = this.dataset.time;
                const employeeName = this.dataset.employeeName;
                const date = this.dataset.date;
                
                openChangeEmployeeModal(scheduleId, eventName, eventType, time, employeeName, date);
            });
        });
        
        // Add event listeners for trade buttons
        document.querySelectorAll('.btn-trade').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const scheduleId = this.dataset.scheduleId;
                const eventName = this.dataset.eventName;
                const employeeName = this.dataset.employeeName;
                const time = this.dataset.time;
                const date = this.dataset.date;

                openTradeModal(scheduleId, eventName, employeeName, time, date);
            });
        });

        // Add event listeners for unschedule buttons
        document.querySelectorAll('.btn-unschedule').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const scheduleId = this.dataset.scheduleId;
                const eventName = this.dataset.eventName;
                const employeeName = this.dataset.employeeName;

                unscheduleEvent(scheduleId, eventName, employeeName);
            });
        });
    }
    
    // Global variable to store current day's data for printing
    let currentDayData = null;
    
    function printDaySchedule() {
        if (!currentDayData || !currentDayData.events) {
            alert('No events data available for printing.');
            return;
        }
        
        // Filter for Core events and Juicer Production events only (excluding surveys)
        const printableEvents = currentDayData.events.filter(event => {
            return event.event_type === 'Core' || 
                   (event.event_type === 'Juicer' && 
                    event.event_name.includes('Production') && 
                    !event.event_name.toLowerCase().includes('survey'));
        });
        
        if (printableEvents.length === 0) {
            alert('No Core or Juicer Production events found for this day.');
            return;
        }
        
        // Sort events by scheduled time
        printableEvents.sort((a, b) => {
            // Convert time strings to comparable format
            const timeA = convertTimeToMinutes(a.time);
            const timeB = convertTimeToMinutes(b.time);
            return timeA - timeB;
        });
        
        // Generate printable HTML
        const printContent = generatePrintableSchedule(currentDayData.formatted_date, printableEvents);
        
        // Create and open print window
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    }
    
    function convertTimeToMinutes(timeStr) {
        // Convert time like "9:15 AM" to minutes for sorting
        const [time, modifier] = timeStr.split(' ');
        const [hours, minutes] = time.split(':');
        let hour = parseInt(hours);
        
        if (modifier === 'PM' && hour !== 12) {
            hour += 12;
        } else if (modifier === 'AM' && hour === 12) {
            hour = 0;
        }
        
        return hour * 60 + parseInt(minutes);
    }
    
    function generatePrintableSchedule(dateStr, printableEvents) {
        return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Core Events Schedule - ${escapeHtml(dateStr)}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 40px;
                    background: white;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 3px solid #2E4C73;
                    padding-bottom: 20px;
                }
                .date-title {
                    font-size: 24px;
                    font-weight: bold;
                    color: #2E4C73;
                    margin: 0;
                }
                .subtitle {
                    font-size: 16px;
                    color: #666;
                    margin: 5px 0 0 0;
                }
                .schedule-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                }
                .schedule-table th {
                    background: #2E4C73;
                    color: white;
                    padding: 12px;
                    text-align: left;
                    font-weight: bold;
                    font-size: 14px;
                    border: 1px solid #ddd;
                }
                .schedule-table td {
                    padding: 10px 12px;
                    border: 1px solid #ddd;
                    font-size: 13px;
                }
                .schedule-table tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                .schedule-table tr:hover {
                    background-color: #f0f0f0;
                }
                .employee-name {
                    font-weight: bold;
                    color: #2E4C73;
                }
                .event-time {
                    font-weight: bold;
                    color: #1B9BD8;
                }
                .event-name {
                    color: #333;
                }
                .footer {
                    margin-top: 40px;
                    text-align: center;
                    font-size: 12px;
                    color: #888;
                    border-top: 1px solid #ddd;
                    padding-top: 20px;
                }
                @media print {
                    body { margin: 20px; }
                    .header { page-break-after: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 class="date-title">${escapeHtml(dateStr)}</h1>
                <p class="subtitle">Daily Schedule</p>
            </div>
            
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Employee Name</th>
                        <th style="width: 20%;">Scheduled Time</th>
                        <th style="width: 50%;">Event Name</th>
                    </tr>
                </thead>
                <tbody>
                    ${printableEvents.map(event => `
                        <tr>
                            <td class="employee-name">${escapeHtml(event.employee_name)}</td>
                            <td class="event-time">${escapeHtml(event.time)}</td>
                            <td class="event-name">${escapeHtml(event.event_name)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="footer">
                <p>Generated on ${new Date().toLocaleString()} | Product Connections Scheduler</p>
            </div>
        </body>
        </html>
        `;
    }
    
    function closeDayDetail() {
        document.getElementById('day-detail-modal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    document.getElementById('day-detail-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDayDetail();
        }
    });
    
    // Event filtering function
    function filterEventsByType() {
        const selectedType = document.getElementById('event-type-filter').value;
        const eventCards = document.querySelectorAll('.day-event-card');
        
        eventCards.forEach(card => {
            if (selectedType === 'all' || card.dataset.eventType === selectedType) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    // Modal management functions
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // Close modals when clicking outside
    document.querySelectorAll('.modal-backdrop').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(this.id);
            }
        });
    });
    
    // Reschedule Modal Functions
    function openRescheduleModal(scheduleId, eventName, eventType, currentTime, employeeName, employeeId, currentDate) {
        try {
            document.getElementById('reschedule-schedule-id').value = scheduleId;
            document.getElementById('reschedule-event-info').innerHTML = `
                <strong>${escapeHtml(eventName)}</strong> (${escapeHtml(eventType)})<br>
                Current: ${escapeHtml(currentDate)} at ${escapeHtml(currentTime)} with ${escapeHtml(employeeName)}
            `;

            // Convert displayed time to 24-hour format for comparison
            const time24 = convertTo24Hour(currentTime);

            // Set up time restrictions for event type
            setupTimeRestrictions('reschedule', eventType, time24);

            // Load available employees with role-based filtering, passing current employee info
            loadAvailableEmployeesForReschedule('reschedule-employee', currentDate, eventType, employeeId, currentDate);

            document.getElementById('reschedule-modal').style.display = 'flex';
        } catch (error) {
            console.error('Error opening reschedule modal:', error);
            alert('Error opening reschedule modal. Please try again.');
        }
    }
    
    // Trade Modal Functions  
    function openTradeModal(scheduleId, eventName, employeeName, time, date) {
        document.getElementById('trade-schedule-id').value = scheduleId;
        document.getElementById('trade-current-info').innerHTML = `
            <strong>${escapeHtml(eventName)}</strong><br>
            ${escapeHtml(employeeName)} at ${escapeHtml(time)}
        `;
        
        // Load employees with Core events on the same date
        loadCoreEmployeesForTrade(date, scheduleId);
        
        document.getElementById('trade-modal').style.display = 'flex';
    }
    
    // Change Employee Modal Functions
    function openChangeEmployeeModal(scheduleId, eventName, eventType, time, employeeName, date) {
        try {
            document.getElementById('change-schedule-id').value = scheduleId;
            document.getElementById('change-event-info').innerHTML = `
                <strong>${escapeHtml(eventName)}</strong> (${escapeHtml(eventType)})<br>
                Date: ${escapeHtml(date)} at ${escapeHtml(time)}<br>
                Current Employee: ${escapeHtml(employeeName)}
            `;
            
            // Load available employees for this date (excluding Core-scheduled employees if this is a Core event)
            loadAvailableEmployeesForChange(date, eventType);
            
            document.getElementById('change-employee-modal').style.display = 'flex';
        } catch (error) {
            console.error('Error opening change employee modal:', error);
            alert('Error opening change employee modal. Please try again.');
        }
    }
    
    // Helper function to setup time restrictions
    function setupTimeRestrictions(prefix, eventType, currentTime) {
        const timeInput = document.getElementById(prefix + '-time');
        const timeDropdown = document.getElementById(prefix + '-time-dropdown');
        
        const timeRestrictions = {
            'Core': ['09:45', '10:30', '11:00', '11:30'],
            'Supervisor': ['12:00'],
            'Freeosk': ['09:00', '12:00'],
            'Digitals': ['09:15', '09:30', '09:45', '10:00']
        };
        
        if (timeRestrictions[eventType]) {
            timeInput.style.display = 'none';
            timeInput.required = false;
            timeDropdown.style.display = 'block';
            timeDropdown.required = true;
            timeDropdown.classList.remove('hidden');
            
            timeDropdown.innerHTML = '<option value="">Select a time</option>';
            timeRestrictions[eventType].forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = formatTime(time);
                if (currentTime && time === currentTime) {
                    option.selected = true;
                }
                timeDropdown.appendChild(option);
            });
            
            // Set default value for Freeosk events if no current time matches
            if (eventType === 'Freeosk' && currentTime && !timeRestrictions[eventType].includes(currentTime)) {
                timeDropdown.value = '09:00';
            }
        } else {
            timeInput.style.display = 'block';
            timeInput.required = true;
            timeDropdown.style.display = 'none';
            timeDropdown.required = false;
            timeDropdown.classList.add('hidden');
        }
    }
    
    // Helper function to format time
    function formatTime(time24) {
        const [hours, minutes] = time24.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        return `${displayHour}:${minutes} ${ampm}`;
    }
    
    // Helper function to convert 12-hour time to 24-hour time
    function convertTo24Hour(time12) {
        if (!time12 || !time12.includes(':')) {
            return time12; // Return as-is if not valid format
        }
        
        const [time, modifier] = time12.split(' ');
        if (!modifier) {
            return time12; // Already in 24-hour format
        }
        
        const [hours, minutes] = time.split(':');
        let hour = parseInt(hours);
        
        if (modifier.toUpperCase() === 'PM' && hour !== 12) {
            hour += 12;
        } else if (modifier.toUpperCase() === 'AM' && hour === 12) {
            hour = 0;
        }
        
        return `${hour.toString().padStart(2, '0')}:${minutes}`;
    }
    
    // Load available employees functions
    function loadAvailableEmployees(selectId, date) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/api/available_employees/${date}`)
            .then(response => response.json())
            .then(employees => {
                select.innerHTML = '<option value="">Select an employee</option>';
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.job_title})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading employees:', error);
                select.innerHTML = '<option value="">Error loading employees</option>';
            });
    }
    
    function loadAvailableEmployeesForReschedule(selectId, date, eventType, employeeId, currentDate) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Loading...</option>';

        // Build API URL with event type and date
        let apiUrl = `/api/available_employees_for_change/${date}/${eventType}`;

        // Add query parameters for current employee and date if both are provided
        if (employeeId && currentDate) {
            apiUrl += `?current_employee_id=${employeeId}&current_date=${currentDate}`;
        }

        fetch(apiUrl)
            .then(response => response.json())
            .then(employees => {
                select.innerHTML = '<option value="">Select an employee</option>';
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.job_title})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading employees:', error);
                select.innerHTML = '<option value="">Error loading employees</option>';
            });
    }
    
    function loadCoreEmployeesForTrade(date, currentScheduleId) {
        const select = document.getElementById('trade-with-employee');
        select.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/api/core_employees_for_trade/${date}/${currentScheduleId}`)
            .then(response => response.json())
            .then(employees => {
                if (employees.length === 0) {
                    select.innerHTML = '<option value="">No other Core events to trade with</option>';
                } else {
                    select.innerHTML = '<option value="">Select employee to trade with...</option>';
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.schedule_id;
                        option.textContent = `${emp.employee_name} - ${emp.event_name} at ${emp.time}`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading trade employees:', error);
                select.innerHTML = '<option value="">Error loading employees</option>';
            });
    }
    
    function loadAvailableEmployeesForChange(date, eventType) {
        const select = document.getElementById('change-new-employee');
        select.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/api/available_employees_for_change/${date}/${eventType}`)
            .then(response => response.json())
            .then(employees => {
                select.innerHTML = '<option value="">Select new employee...</option>';
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.job_title})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading employees:', error);
                select.innerHTML = '<option value="">Error loading employees</option>';
            });
    }
    
    // Form submission handlers
    document.getElementById('reschedule-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scheduleId = document.getElementById('reschedule-schedule-id').value;
        const date = document.getElementById('reschedule-date').value;
        const timeInput = document.getElementById('reschedule-time');
        const timeDropdown = document.getElementById('reschedule-time-dropdown');
        const time = timeDropdown.style.display !== 'none' ? timeDropdown.value : timeInput.value;
        const employeeId = document.getElementById('reschedule-employee').value;
        
        if (!date || !time || !employeeId) {
            alert('Please fill in all fields');
            return;
        }
        
        fetch('/api/reschedule', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                schedule_id: parseInt(scheduleId),
                new_date: date,
                new_time: time,
                employee_id: employeeId
            })
        })
        .then(response => {
            // Store the status before parsing JSON
            const status = response.status;
            return response.json().then(data => ({ status, data }));
        })
        .then(({ status, data }) => {
            if (data.success) {
                alert(data.message);
                closeModal('reschedule-modal');
                location.reload(); // Refresh calendar
            } else if (status === 409 && data.error && data.error.includes('locked')) {
                // Locked day error - show clear message
                alert(`üîí Day is Locked\n\n${data.error}\n\nTo reschedule this event, first unlock the day using the "Lock Day" button.`);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error rescheduling event');
        });
    });
    
    document.getElementById('trade-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scheduleId = document.getElementById('trade-schedule-id').value;
        const tradeWithScheduleId = document.getElementById('trade-with-employee').value;
        
        if (!tradeWithScheduleId) {
            alert('Please select an employee to trade with');
            return;
        }
        
        fetch('/api/trade_events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                schedule_id: parseInt(scheduleId),
                trade_with_schedule_id: parseInt(tradeWithScheduleId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal('trade-modal');
                location.reload(); // Refresh calendar
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error trading events');
        });
    });
    
    document.getElementById('change-employee-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const scheduleId = document.getElementById('change-schedule-id').value;
        const newEmployeeId = document.getElementById('change-new-employee').value;

        if (!newEmployeeId) {
            alert('Please select a new employee');
            return;
        }

        fetch('/api/change_employee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                schedule_id: parseInt(scheduleId),
                employee_id: newEmployeeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal('change-employee-modal');
                location.reload(); // Refresh calendar
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error changing employee');
        });
    });

    // Unschedule Event Function
    function unscheduleEvent(scheduleId, eventName, employeeName) {
        // Confirm before unscheduling
        const confirmMessage = `Are you sure you want to unschedule this event?\n\nEvent: ${eventName}\nEmployee: ${employeeName}\n\nThis will remove the event from the schedule and mark it as unscheduled.`;

        if (!confirm(confirmMessage)) {
            return;
        }

        fetch(`/api/unschedule/${scheduleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload(); // Refresh calendar
            } else {
                alert('Error: ' + (data.error || 'Failed to unschedule event'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error unscheduling event. Please try again.');
        });
    }

    /* ===================================================================
       Lock/Unlock Day Functions
       =================================================================== */

    /**
     * Update the modal lock button state
     */
    function updateModalLockButton() {
        const lockIcon = document.getElementById('modal-lock-icon');
        const lockText = document.getElementById('modal-lock-text');
        const lockBtn = document.getElementById('lock-day-btn');

        if (!lockIcon || !lockText || !lockBtn) return;

        if (currentModalLocked) {
            lockIcon.textContent = 'üîí';
            lockText.textContent = 'Unlock Day';
            lockBtn.classList.add('btn-locked');
            lockBtn.classList.remove('btn-unlocked');
            const lockInfo = lockedDaysData[currentModalDate];
            lockBtn.title = lockInfo ?
                `Locked by ${lockInfo.locked_by}${lockInfo.reason ? ': ' + lockInfo.reason : ''}` :
                'Day is locked';
        } else {
            lockIcon.textContent = 'üîì';
            lockText.textContent = 'Lock Day';
            lockBtn.classList.add('btn-unlocked');
            lockBtn.classList.remove('btn-locked');
            lockBtn.title = 'Lock this day to prevent schedule changes';
        }
    }

    /**
     * Toggle lock state for the current modal day
     */
    async function toggleDayLock() {
        if (!currentModalDate) return;

        if (currentModalLocked) {
            await unlockDay(currentModalDate);
        } else {
            await lockDay(currentModalDate);
        }
    }

    /**
     * Lock a specific day
     */
    async function lockDay(dateStr) {
        const reason = prompt('Enter a reason for locking this day (optional):', 'Schedule finalized');

        // User cancelled the prompt
        if (reason === null) return;

        try {
            const response = await fetch('/api/locked-days', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: dateStr,
                    reason: reason || 'Schedule finalized',
                    locked_by: 'User'
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update local data
                lockedDaysData[dateStr] = data.locked_day;
                currentModalLocked = true;
                updateModalLockButton();

                // Update calendar day element
                const dayElement = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
                if (dayElement) {
                    dayElement.classList.add('is-locked');
                    // Add lock indicator if not present
                    if (!dayElement.querySelector('.lock-indicator')) {
                        const lockIndicator = document.createElement('div');
                        lockIndicator.className = 'lock-indicator';
                        lockIndicator.dataset.date = dateStr;
                        lockIndicator.title = `Day is locked: ${reason || 'Schedule finalized'}`;
                        lockIndicator.textContent = 'üîí';
                        dayElement.insertBefore(lockIndicator, dayElement.firstChild);
                    }
                }

                alert(`Day ${dateStr} has been locked.`);
            } else {
                alert(`Failed to lock day: ${data.error}`);
            }
        } catch (error) {
            console.error('Error locking day:', error);
            alert('Failed to lock day. Please try again.');
        }
    }

    /**
     * Unlock a specific day
     */
    async function unlockDay(dateStr) {
        if (!confirm('Are you sure you want to unlock this day? This will allow schedule modifications.')) {
            return;
        }

        try {
            const response = await fetch(`/api/locked-days/${dateStr}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success) {
                // Update local data
                delete lockedDaysData[dateStr];
                currentModalLocked = false;
                updateModalLockButton();

                // Update calendar day element
                const dayElement = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
                if (dayElement) {
                    dayElement.classList.remove('is-locked');
                    // Remove lock indicator
                    const lockIndicator = dayElement.querySelector('.lock-indicator');
                    if (lockIndicator) {
                        lockIndicator.remove();
                    }
                }

                alert(`Day ${dateStr} has been unlocked.`);
            } else {
                alert(`Failed to unlock day: ${data.error}`);
            }
        } catch (error) {
            console.error('Error unlocking day:', error);
            alert('Failed to unlock day. Please try again.');
        }
    }

    // Delegated click handler - replaces inline onclick attributes
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;

        switch (action) {
            case 'go-today': goToToday(); break;
            case 'change-month': changeMonth(parseInt(target.dataset.delta)); break;
            case 'close-day-detail': closeDayDetail(); break;
            case 'toggle-day-lock': toggleDayLock(); break;
            case 'print-day-schedule': printDaySchedule(); break;
            case 'close-modal': closeModal(target.dataset.modal); break;
        }
    });

    // Delegated change handler for select filters
    document.addEventListener('change', function(e) {
        const target = e.target.closest('[data-action="filter-events"]');
        if (target) filterEventsByType();
    });
</script>
{% endblock %}