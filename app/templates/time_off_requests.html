{% extends "base.html" %}

{% block title %}Time Off Requests - Product Connections Scheduler{% endblock %}

{% block extra_head %}
<style>
    .page-header {
        text-align: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--pc-light-blue);
    }

    .page-title {
        font-size: var(--font-size-h1);
        font-weight: var(--font-weight-heading);
        color: var(--pc-navy);
        margin: 0;
        letter-spacing: -0.02em;
    }

    .controls-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .filter-section {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 1;
    }

    .filter-section label {
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
        white-space: nowrap;
    }

    .filter-section select {
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid #ddd;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-body);
        min-width: 200px;
    }

    .filter-section select:focus {
        outline: none;
        border-color: var(--pc-blue);
        box-shadow: 0 0 0 2px rgba(27, 155, 216, 0.2);
    }

    .time-off-list {
        background: var(--bg-primary);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
    }

    .time-off-request-card {
        background: var(--bg-secondary);
        border-left: 4px solid var(--pc-light-blue);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }

    .time-off-request-card:hover {
        box-shadow: var(--shadow-sm);
        transform: translateX(4px);
    }

    .time-off-request-card:last-child {
        margin-bottom: 0;
    }

    .time-off-info {
        flex: 1;
    }

    .time-off-employee {
        font-size: var(--font-size-body);
        font-weight: var(--font-weight-bold);
        color: var(--pc-navy);
        margin-bottom: var(--spacing-xs);
    }

    .time-off-dates {
        font-size: var(--font-size-small);
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
    }

    .time-off-reason {
        font-size: var(--font-size-small);
        color: var(--text-muted);
        font-style: italic;
    }

    .time-off-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .btn-delete {
        background: #fff;
        border: 1px solid #dc3545;
        color: #dc3545;
        padding: 6px 12px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: var(--font-size-small);
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .btn-delete:hover {
        background: #dc3545;
        color: white;
    }

    .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--text-muted);
        font-size: var(--font-size-body);
    }

    /* Modal Styles */
    /* Modal base styles are handled by modals.css */
    /* Custom modal enhancements for this page */
    #add-request-modal .modal-header {
        border-bottom: 2px solid var(--pc-light-blue);
    }

    #add-request-modal .modal-title {
        color: var(--pc-navy);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .form-row.full {
        grid-template-columns: 1fr;
    }

    .form-group {
        margin-bottom: var(--spacing-md);
    }

    .form-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid #ddd;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-body);
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--pc-blue);
        box-shadow: 0 0 0 2px rgba(27, 155, 216, 0.2);
    }

    /* modal-footer styles are in modals.css */

    .alert {
        padding: 12px 16px;
        border-radius: var(--border-radius-sm);
        margin-bottom: var(--spacing-md);
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    @media (max-width: 768px) {
        .controls-section {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-section {
            width: 100%;
        }

        .filter-section select {
            width: 100%;
        }

        .form-row {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Availability Management</h1>
</div>

<!-- Tab Navigation -->
<div class="condition-tabs" style="margin-bottom: var(--spacing-lg);">
    <button class="tab-btn active" data-action="show-tab" data-tab="time-off">Time Off Requests</button>
    <button class="tab-btn" data-action="show-tab" data-tab="overrides">Availability Overrides</button>
</div>

<!-- Flash messages -->
<div id="flash-messages"></div>

<!-- ===== TIME OFF TAB ===== -->
<div id="tab-time-off">
    <!-- Controls Section -->
    <div class="controls-section">
        <div class="filter-section">
            <label for="employee-filter">Filter by Employee:</label>
            <select id="employee-filter">
                <option value="all">All Employees</option>
            </select>
        </div>
        <button id="add-request-btn" class="btn btn-primary">
            + Add Request
        </button>
    </div>

    <!-- Time Off Requests List -->
    <div class="time-off-list">
        <div id="requests-container">
            <div class="empty-state">Loading time off requests...</div>
        </div>
    </div>
</div>

<!-- ===== OVERRIDES TAB ===== -->
<div id="tab-overrides" style="display: none;">
    <div class="controls-section">
        <div class="filter-section">
            <label for="override-employee-filter">Filter by Employee:</label>
            <select id="override-employee-filter">
                <option value="all">All Employees</option>
            </select>
        </div>
        <button class="btn btn-primary" data-action="show-add-override-modal">
            + Add Override
        </button>
    </div>

    <div class="time-off-list">
        <div id="overrides-container">
            <div class="empty-state">Loading availability overrides...</div>
        </div>
    </div>
</div>

<!-- Add Time Off Request Modal -->
<div id="add-request-modal" class="modal">
    <div class="modal-overlay" data-action="close-add-request-modal"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">Add Time Off Request</h2>
            <button class="modal-close" data-action="close-add-request-modal" aria-label="Close">&times;</button>
        </div>

        <div class="modal-body">
            <div id="modal-alerts"></div>

            <form id="add-request-form">
                <div class="form-row full">
                    <div class="form-group">
                        <label for="request-employee">Employee *</label>
                        <select id="request-employee" required>
                            <option value="">Select an employee...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="request-start-date">Start Date *</label>
                        <input type="date" id="request-start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="request-end-date">End Date *</label>
                        <input type="date" id="request-end-date" required>
                    </div>
                </div>

                <div class="form-row full">
                    <div class="form-group">
                        <label for="request-comments">Comments (Optional)</label>
                        <textarea id="request-comments" rows="3"
                            placeholder="e.g., Vacation, Personal, Medical"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="close-add-request-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Request</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Add Availability Override Modal -->
<div id="add-override-modal" class="modal">
    <div class="modal-overlay" data-action="close-override-modal"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">Add Availability Override</h2>
            <button class="modal-close" data-action="close-override-modal" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="override-modal-alerts"></div>
            <form id="add-override-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="override-employee">Employee</label>
                        <select id="override-employee" required>
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="override-start-date">Start Date</label>
                        <input type="date" id="override-start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="override-end-date">End Date</label>
                        <input type="date" id="override-end-date" required>
                    </div>
                </div>
                <fieldset style="border: 1px solid #ddd; border-radius: 6px; padding: 12px 16px; margin-bottom: 16px;">
                    <legend style="font-weight: 600; font-size: 14px; padding: 0 8px;">Available Days</legend>
                    <div style="display: flex; flex-wrap: wrap; gap: 16px;">
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" name="override-monday" checked> Mon
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" name="override-tuesday" checked> Tue
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" name="override-wednesday" checked> Wed
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" name="override-thursday" checked> Thu
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" name="override-friday" checked> Fri
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" name="override-saturday"> Sat
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                            <input type="checkbox" name="override-sunday"> Sun
                        </label>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label for="override-reason">Reason (optional)</label>
                    <input type="text" id="override-reason" placeholder="e.g., College class schedule" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="close-override-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Override</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let allRequests = [];
    let allEmployees = [];

    // Initialize page on load
    document.addEventListener('DOMContentLoaded', function () {
        // Move modal to body to avoid z-index/overflow issues
        const modal = document.getElementById('add-request-modal');
        if (modal && modal.parentElement !== document.body) {
            document.body.appendChild(modal);
            console.log('Modal moved to body');
        }

        initializePage();
    });

    async function initializePage() {
        // Load employees
        await loadEmployees();

        // Load time off requests
        await loadAllTimeOffRequests();

        // Setup event listeners
        setupEventListeners();

        // Setup end date default behavior
        setupDateInputs();
    }

    function setupEventListeners() {
        try {
            console.log('Setting up event listeners...');

            // Add request button
            const addBtn = document.getElementById('add-request-btn');
            if (!addBtn) {
                console.error('add-request-btn not found');
                return;
            }
            addBtn.addEventListener('click', function () {
                console.log('Add Request button clicked');
                openAddRequestModal();
            });

            // Employee filter
            const filterSelect = document.getElementById('employee-filter');
            if (filterSelect) {
                filterSelect.addEventListener('change', filterRequests);
            }

            // Add request form submission
            const form = document.getElementById('add-request-form');
            if (!form) {
                console.error('add-request-form not found');
                return;
            }
            form.addEventListener('submit', function (e) {
                console.log('Form submitted');
                handleAddRequest(e);
            });

            // Modal overlay click handler is in delegated listener below

            console.log('Event listeners set up successfully');
        } catch (error) {
            console.error('Error setting up event listeners:', error);
        }
    }

    function setupDateInputs() {
        const startDateInput = document.getElementById('request-start-date');
        const endDateInput = document.getElementById('request-end-date');

        // When start date changes, update end date default
        startDateInput.addEventListener('change', function () {
            if (!endDateInput.value || endDateInput.value < startDateInput.value) {
                endDateInput.value = startDateInput.value;
            }
        });
    }

    async function loadEmployees() {
        try {
            const response = await fetch('/api/employees');
            if (!response.ok) throw new Error('Failed to load employees');

            allEmployees = await response.json();

            // Populate employee filter dropdown
            const filterSelect = document.getElementById('employee-filter');
            filterSelect.innerHTML = '<option value="all">All Employees</option>';

            allEmployees
                .filter(emp => emp.is_active)
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = toTitleCase(emp.name);
                    filterSelect.appendChild(option);
                });

            // Populate employee dropdown in modal
            const modalSelect = document.getElementById('request-employee');
            modalSelect.innerHTML = '<option value="">Select an employee...</option>';

            allEmployees
                .filter(emp => emp.is_active)
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = toTitleCase(emp.name);
                    modalSelect.appendChild(option);
                });
        } catch (error) {
            console.error('Error loading employees:', error);
            showFlashMessage('Error loading employees', 'error');
        }
    }

    async function loadAllTimeOffRequests() {
        try {
            const container = document.getElementById('requests-container');
            container.innerHTML = '<div class="empty-state">Loading time off requests...</div>';

            // Fetch all time off requests from all employees
            const requests = [];

            for (const employee of allEmployees) {
                const response = await fetch(`/api/employees/${employee.id}/time_off`);
                if (response.ok) {
                    const employeeRequests = await response.json();
                    employeeRequests.forEach(req => {
                        requests.push({
                            ...req,
                            employee_id: employee.id,
                            employee_name: employee.name
                        });
                    });
                }
            }

            // Sort by date (most recent first) - compare date strings directly
            requests.sort((a, b) => b.start_date.localeCompare(a.start_date));

            allRequests = requests;
            displayRequests(requests);
        } catch (error) {
            console.error('Error loading time off requests:', error);
            const container = document.getElementById('requests-container');
            container.innerHTML = '<div class="alert alert-error">Error loading time off requests</div>';
        }
    }

    function filterRequests() {
        const filterValue = document.getElementById('employee-filter').value;

        if (filterValue === 'all') {
            displayRequests(allRequests);
        } else {
            const filtered = allRequests.filter(req => req.employee_id === filterValue);
            displayRequests(filtered);
        }
    }

    function displayRequests(requests) {
        const container = document.getElementById('requests-container');

        if (requests.length === 0) {
            container.innerHTML = '<div class="empty-state">No time off requests found</div>';
            return;
        }

        container.innerHTML = requests.map(req => createRequestCard(req)).join('');
    }

    function createRequestCard(request) {
        // Parse dates without timezone conversion (use date string directly)
        const startDate = request.start_date; // Already in YYYY-MM-DD format
        const endDate = request.end_date;

        // Format dates for display
        const formatDate = (dateStr) => {
            const [year, month, day] = dateStr.split('-');
            return new Date(year, month - 1, day).toLocaleDateString();
        };

        const dateDisplay = startDate === endDate
            ? formatDate(startDate)
            : `${formatDate(startDate)} - ${formatDate(endDate)}`;

        return `
        <div class="time-off-request-card">
            <div class="time-off-info">
                <div class="time-off-employee">${toTitleCase(request.employee_name)}</div>
                <div class="time-off-dates">üóìÔ∏è ${dateDisplay}</div>
                ${request.reason ? `<div class="time-off-reason">Comments: ${request.reason}</div>` : ''}
            </div>
            <div class="time-off-actions">
                <button class="btn-delete" data-action="delete-request" data-request-id="${request.id}">Delete</button>
            </div>
        </div>
    `;
    }

    function openAddRequestModal() {
        try {
            console.log('Opening add request modal');
            const modal = document.getElementById('add-request-modal');
            if (!modal) {
                console.error('Modal not found');
                return;
            }

            modal.classList.add('modal-open');
            document.getElementById('add-request-form').reset();
            document.getElementById('modal-alerts').innerHTML = '';

            // Set default dates to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('request-start-date').value = today;
            document.getElementById('request-end-date').value = today;

            console.log('Modal opened successfully');
        } catch (error) {
            console.error('Error opening modal:', error);
        }
    }

    function closeAddRequestModal() {
        document.getElementById('add-request-modal').classList.remove('modal-open');
        document.getElementById('add-request-form').reset();
        document.getElementById('modal-alerts').innerHTML = '';
    }

    async function handleAddRequest(e) {
        console.log('handleAddRequest called');
        e.preventDefault();

        const employeeId = document.getElementById('request-employee').value;
        const startDate = document.getElementById('request-start-date').value;
        const endDate = document.getElementById('request-end-date').value;
        const comments = document.getElementById('request-comments').value.trim();

        console.log('Form values:', { employeeId, startDate, endDate, comments });

        if (!employeeId || !startDate || !endDate) {
            showModalAlert('All required fields must be filled', 'error');
            return;
        }

        // Compare dates as strings (YYYY-MM-DD format is lexicographically sortable)
        if (endDate < startDate) {
            showModalAlert('End date cannot be before start date', 'error');
            return;
        }

        // Helper function to submit request with optional unschedule flag
        const submitTimeOff = async (unscheduleConflicts = false) => {
            const response = await fetch(`/api/employees/${employeeId}/time_off`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate,
                    reason: comments,
                    unschedule_conflicts: unscheduleConflicts
                })
            });

            return {
                response,
                data: await response.json()
            };
        };

        try {
            console.log('Sending POST request to /api/employees/' + employeeId + '/time_off');

            let { response, data } = await submitTimeOff(false);

            console.log('Response status:', response.status);
            console.log('Response data:', data);

            // Handle 409 conflict with scheduled events
            if (response.status === 409 && data.conflicts) {
                // Get employee name for display
                const employeeSelect = document.getElementById('request-employee');
                const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;

                // Build conflict list for display
                const conflictList = data.conflicts.map(c =>
                    `‚Ä¢ ${c.event_name} on ${c.date} at ${c.time}`
                ).join('\n');

                const confirmUnschedule = confirm(
                    `‚ö†Ô∏è Scheduling Conflict Detected\n\n` +
                    `${employeeName} has ${data.conflicts.length} event(s) scheduled during this time off:\n\n` +
                    conflictList + `\n\n` +
                    `Do you want to UNSCHEDULE these events and add the time off request?\n\n` +
                    `Click OK to unschedule and add time off, or Cancel to go back.`
                );

                if (confirmUnschedule) {
                    // Re-submit with unschedule flag
                    console.log('User confirmed unschedule - retrying with unschedule_conflicts=true');
                    const retryResult = await submitTimeOff(true);
                    response = retryResult.response;
                    data = retryResult.data;

                    if (!response.ok) {
                        showModalAlert(`Error: ${data.error}`, 'error');
                        return;
                    }

                    // Show success with unschedule info
                    const eventsCount = data.events_unscheduled || data.conflicts?.length || 0;
                    showFlashMessage(
                        `Time off request added! ${eventsCount} event(s) were unscheduled.`,
                        'success'
                    );
                } else {
                    // User cancelled - don't proceed
                    console.log('User cancelled unschedule');
                    return;
                }
            } else if (!response.ok) {
                showModalAlert(`Error: ${data.error || data.warning}`, 'error');
                return;
            } else {
                // Success without conflicts
                showFlashMessage('Time off request added successfully!', 'success');
            }

            closeAddRequestModal();

            // Reload requests
            await loadAllTimeOffRequests();

            // Reapply filter if active
            filterRequests();
        } catch (error) {
            console.error('Error adding request:', error);
            showModalAlert('Error adding time off request. Please try again.', 'error');
        }
    }

    async function deleteRequest(requestId) {
        if (!confirm('Are you sure you want to delete this time off request?')) {
            return;
        }

        try {
            const response = await fetch(`/api/time_off/${requestId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok) {
                showFlashMessage(`Error: ${data.error}`, 'error');
                return;
            }

            showFlashMessage('Time off request deleted successfully!', 'success');

            // Reload requests
            await loadAllTimeOffRequests();

            // Reapply filter if active
            filterRequests();
        } catch (error) {
            console.error('Error deleting request:', error);
            showFlashMessage('Error deleting time off request. Please try again.', 'error');
        }
    }

    function showModalAlert(message, type) {
        const alerts = document.getElementById('modal-alerts');
        alerts.innerHTML = `<div class="alert alert-${type}">${message}</div>`;

        // Auto-dismiss success messages after 3 seconds
        if (type === 'success') {
            setTimeout(() => {
                alerts.innerHTML = '';
            }, 3000);
        }
    }

    function showFlashMessage(message, type) {
        const flashContainer = document.getElementById('flash-messages');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        flashContainer.appendChild(alertDiv);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // ===== TAB SWITCHING =====
    function showTab(tabName) {
        document.getElementById('tab-time-off').style.display = tabName === 'time-off' ? '' : 'none';
        document.getElementById('tab-overrides').style.display = tabName === 'overrides' ? '' : 'none';
        document.querySelectorAll('[data-action="show-tab"]').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.tab === tabName);
        });
        if (tabName === 'overrides') loadOverrides();
    }

    // ===== OVERRIDES MANAGEMENT =====
    function loadOverrides() {
        var filter = document.getElementById('override-employee-filter').value;
        var container = document.getElementById('overrides-container');
        if (filter === 'all') {
            // Load for all employees
            container.innerHTML = '<div class="empty-state">Select an employee to view overrides, or add a new one.</div>';
            // Load all active employees to show their overrides
            fetch('/api/employees/active')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var employees = data.employees || data;
                    if (!employees || employees.length === 0) return;
                    var promises = employees.map(function(emp) {
                        return fetch('/api/availability-overrides/' + emp.id)
                            .then(function(r) { return r.json(); })
                            .then(function(d) { return { employee: emp, overrides: d.overrides || [] }; });
                    });
                    Promise.all(promises).then(function(results) {
                        var all = [];
                        results.forEach(function(r) {
                            r.overrides.forEach(function(o) { o._employee_name = r.employee.name; all.push(o); });
                        });
                        renderOverrides(all);
                    });
                });
        } else {
            fetch('/api/availability-overrides/' + filter)
                .then(function(r) { return r.json(); })
                .then(function(data) { renderOverrides(data.overrides || []); });
        }
    }

    function renderOverrides(overrides) {
        var container = document.getElementById('overrides-container');
        if (!overrides || overrides.length === 0) {
            container.innerHTML = '<div class="empty-state">No availability overrides found.</div>';
            return;
        }
        var dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        var html = '';
        overrides.forEach(function(o) {
            var days = [o.monday, o.tuesday, o.wednesday, o.thursday, o.friday, o.saturday, o.sunday];
            var activeDays = days.map(function(d, i) { return d ? dayNames[i] : null; }).filter(Boolean).join(', ');
            var empName = o._employee_name ? toTitleCase(o._employee_name) : 'Employee ' + o.employee_id;
            var today = new Date().toISOString().split('T')[0];
            var isExpired = o.end_date < today;
            var statusClass = isExpired ? 'style="opacity: 0.5;"' : '';

            html += '<div class="time-off-card" ' + statusClass + '>' +
                '<div class="time-off-details">' +
                '<div class="employee-name">' + escapeHtml(empName) + '</div>' +
                '<div class="date-range">' + o.start_date + ' to ' + o.end_date +
                (isExpired ? ' <span style="color:#dc3545;">(Expired)</span>' : '') + '</div>' +
                '<div style="font-size:13px; color:#666;">Available: <strong>' + (activeDays || 'None') + '</strong></div>' +
                (o.reason ? '<div style="font-size:12px; color:#888; margin-top:4px;">Reason: ' + escapeHtml(o.reason) + '</div>' : '') +
                '</div>' +
                '<div class="time-off-actions">' +
                '<button class="btn btn-danger btn-sm" data-action="delete-override" data-override-id="' + o.id + '">Delete</button>' +
                '</div></div>';
        });
        container.innerHTML = html;
    }

    function showAddOverrideModal() {
        document.getElementById('add-override-modal').classList.add('active');
        // Populate employee dropdown
        fetch('/api/employees/active')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var select = document.getElementById('override-employee');
                select.innerHTML = '<option value="">Select Employee</option>';
                var employees = data.employees || data;
                employees.forEach(function(emp) {
                    select.innerHTML += '<option value="' + emp.id + '">' + toTitleCase(emp.name) + '</option>';
                });
            });
    }

    function closeOverrideModal() {
        document.getElementById('add-override-modal').classList.remove('active');
        document.getElementById('add-override-form').reset();
    }

    document.getElementById('add-override-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var payload = {
            employee_id: document.getElementById('override-employee').value,
            start_date: document.getElementById('override-start-date').value,
            end_date: document.getElementById('override-end-date').value,
            monday: document.querySelector('[name="override-monday"]').checked,
            tuesday: document.querySelector('[name="override-tuesday"]').checked,
            wednesday: document.querySelector('[name="override-wednesday"]').checked,
            thursday: document.querySelector('[name="override-thursday"]').checked,
            friday: document.querySelector('[name="override-friday"]').checked,
            saturday: document.querySelector('[name="override-saturday"]').checked,
            sunday: document.querySelector('[name="override-sunday"]').checked,
            reason: document.getElementById('override-reason').value
        };
        fetch('/api/availability-overrides', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                closeOverrideModal();
                loadOverrides();
            } else {
                document.getElementById('override-modal-alerts').innerHTML =
                    '<div class="alert alert-error">' + (data.error || 'Failed to create override') + '</div>';
            }
        })
        .catch(function(err) { alert('Error: ' + err); });
    });

    function deleteOverride(overrideId) {
        if (!confirm('Delete this availability override?')) return;
        fetch('/api/availability-overrides/' + overrideId, { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) loadOverrides();
                else alert(data.error || 'Failed to delete');
            });
    }

    // Populate override employee filter
    fetch('/api/employees/active')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var select = document.getElementById('override-employee-filter');
            var employees = data.employees || data;
            employees.forEach(function(emp) {
                select.innerHTML += '<option value="' + emp.id + '">' + toTitleCase(emp.name) + '</option>';
            });
        });

    document.getElementById('override-employee-filter').addEventListener('change', loadOverrides);

    // Delegated click handler for data-action buttons
    document.addEventListener('click', function(e) {
        var target = e.target.closest('[data-action]');
        if (!target) return;
        var action = target.dataset.action;
        switch (action) {
            case 'close-add-request-modal':
                closeAddRequestModal();
                break;
            case 'delete-request':
                deleteRequest(parseInt(target.dataset.requestId));
                break;
            case 'show-tab':
                showTab(target.dataset.tab);
                break;
            case 'show-add-override-modal':
                showAddOverrideModal();
                break;
            case 'close-override-modal':
                closeOverrideModal();
                break;
            case 'delete-override':
                deleteOverride(parseInt(target.dataset.overrideId));
                break;
        }
    });
</script>
{% endblock %}