{#
  Template: daily_view.html
  Route: main.daily_schedule_view (GET /schedule/daily/<date>)

  Context variables:
    selected_date  (date)           - The date being viewed
    juicer         (AssignmentWrapper|None) - Juicer rotation for this day (.employee)
    primary_lead   (AssignmentWrapper|None) - Primary lead rotation (.employee)
    prev_date      (date)           - Previous day for navigation
    next_date      (date)           - Next day for navigation
    employees      (list[Employee]) - Active employees for reassignment dropdown
    today          (date)           - Current date for reissue logic
#}
{% extends "base.html" %}

{% block title %}Daily Schedule - {{ selected_date.strftime('%A, %B %d, %Y') }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet"
  href="{{ url_for('static', filename='css/pages/daily-view.css') }}?v={{ config.get('VERSION', '1.0') }}">
<style>
  /* Modal styles for reschedule functionality */
  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1001;
  }

  .action-modal {
    background: var(--bg-primary);
    border-radius: var(--border-radius-lg);
    padding: var(--spacing-xl);
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    position: relative;
  }

  .action-modal h2,
  .action-modal h3 {
    margin-top: 0;
    color: var(--text-primary);
  }

  .action-modal header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--pc-light-blue);
  }

  .action-modal header h2 {
    margin: 0;
  }

  .action-modal footer {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid #ddd;
  }

  .required-indicator {
    color: #DC2626;
    font-weight: 700;
  }

  .action-modal .form-group {
    margin-bottom: var(--spacing-md);
  }

  .action-modal .form-group label {
    display: block;
    margin-bottom: var(--spacing-xs);
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
  }

  .action-modal .form-group input,
  .action-modal .form-group select {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid #ddd;
    border-radius: var(--border-radius-sm);
    box-sizing: border-box;
  }



  .hidden {
    display: none !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="daily-view-container" data-selected-date="{{ selected_date.strftime('%Y-%m-%d') }}" data-today="{{ today.strftime('%Y-%m-%d') }}" role="main" aria-label="Daily schedule view">
  <!-- Header Section -->
  <header class="daily-view-header">
    <!-- Back to Calendar Button -->
    <nav aria-label="Breadcrumb navigation">
      <a href="{{ url_for('main.calendar_view') }}" class="btn-back" aria-label="Back to calendar">
      <span class="icon">←</span>
      <span class="btn-text">Back to Calendar</span>
      </a>
    </nav>

    <!-- Date Navigation -->
    <nav class="date-navigation" aria-label="Date navigation">
      <a href="{{ url_for('main.daily_schedule_view', date=prev_date.strftime('%Y-%m-%d')) }}"
        class="btn-nav btn-nav-prev" aria-label="Previous day, {{ prev_date.strftime('%A, %B %d') }}">
        ←
      </a>

      <h1 class="daily-date" id="page-title">
        <time datetime="{{ selected_date.strftime('%Y-%m-%d') }}">{{ selected_date.strftime('%A, %B %d, %Y').upper() }}</time>
      </h1>

      <a href="{{ url_for('main.daily_schedule_view', date=next_date.strftime('%Y-%m-%d')) }}"
        class="btn-nav btn-nav-next" aria-label="Next day, {{ next_date.strftime('%A, %B %d') }}">
        →
      </a>
    </nav>

    <!-- Bulk Actions -->
    <div role="toolbar" aria-label="Bulk actions" class="bulk-actions">
      <button type="button" class="btn btn-secondary" id="btn-bulk-reassign-supervisor"
        aria-label="Reassign all supervisor events">
        <span class="icon"><span class="material-symbols-outlined">sync</span></span>
        <span class="btn-text">Reassign Supervisor Events</span>
      </button>

      <!-- Lock/Unlock Day Button -->
      <button type="button" class="btn btn-lock" id="btn-lock-day"
        data-date="{{ selected_date.strftime('%Y-%m-%d') }}"
        aria-label="Lock or unlock this day">
        <span class="icon" id="lock-icon"><span class="material-symbols-outlined">lock_open</span></span>
        <span class="btn-text" id="lock-text">Lock Day</span>
      </button>
    </div>

    <!-- Role Assignments -->
    <section aria-labelledby="role-assignments-heading" class="role-assignments">
      <h2 class="sr-only" id="role-assignments-heading">Daily Role Assignments</h2>
      <div class="role-item">
        <span class="role-icon" aria-hidden="true"><span class="material-symbols-outlined">blender</span></span>
        <span class="role-label">Juicer:</span>
        {% if juicer and juicer.employee %}
        <strong class="role-value">{{ juicer.employee.name }}</strong>
        {% else %}
        <span class="no-assignment">No Juicer assigned</span>
        <a href="{{ url_for('rotations.index') }}" class="link-subtle"
          aria-label="Assign Juicer for this day">Assign</a>
        {% endif %}
      </div>

      <div class="role-item">
        <span class="role-icon" aria-hidden="true"><span class="material-symbols-outlined">star</span></span>
        <span class="role-label">Primary Lead Event Specialist:</span>
        {% if primary_lead and primary_lead.employee %}
        <strong class="role-value">{{ primary_lead.employee.name }}</strong>
        {% else %}
        <span class="no-assignment">No Primary Lead assigned</span>
        <a href="{{ url_for('rotations.index') }}" class="link-subtle"
          aria-label="Assign Primary Lead for this day">Assign</a>
        {% endif %}
      </div>
    </section>
  </header>

  <!-- Main Content Area -->
  <main class="daily-view-content" aria-label="Daily schedule content">
    <!-- Event Type Summary -->
    <div id="daily-summary" class="dashboard-section">
      <!-- JavaScript will populate this -->
      <div class="loading-state" role="status" aria-live="polite">
        <div class="spinner"></div>
        <span class="sr-only">Loading summary...</span>
      </div>
    </div>

    <!-- Core Timeslot Coverage -->
    <div class="dashboard-section">
      <h3 class="section-title">Core Timeslot Coverage</h3>
      <div id="timeslot-blocks" class="timeslot-grid">
        <!-- JavaScript will populate this -->
        <div class="loading-state" role="status" aria-live="polite">
          <div class="spinner"></div>
          <span class="sr-only">Loading timeslots...</span>
        </div>
      </div>
    </div>

    <!-- Employee Attendance Section (Separate from Events) -->
    <div class="dashboard-section">
      <h3 class="section-title">Employee Attendance</h3>
      <div id="attendance-list-container" class="attendance-list">
        <!-- JavaScript will populate this -->
        <div class="loading-state" role="status" aria-live="polite">
          <div class="spinner"></div>
          <span class="sr-only">Loading attendance...</span>
        </div>
      </div>
    </div>

    <!-- Event Cards Section (Story 3.3) -->
    <div class="dashboard-section">
      <div class="section-header">
        <h3 class="section-title">Scheduled Events</h3>
        <div class="section-controls">
          <!-- View Toggle -->
          <div class="view-toggle" role="group" aria-label="View mode">
            <button type="button" class="view-toggle-btn active" data-view="card" aria-pressed="true">
              <span class="toggle-icon"><span class="material-symbols-outlined">grid_view</span></span> Card
            </button>
            <button type="button" class="view-toggle-btn" data-view="list" aria-pressed="false">
              <span class="toggle-icon"><span class="material-symbols-outlined">view_list</span></span> List
            </button>
          </div>
          <!-- Type Filter -->
          <div class="event-filter">
            <label for="event-type-filter" class="filter-label">Filter:</label>
            <select id="event-type-filter" class="filter-select">
              <option value="all">All Types</option>
              <option value="Juicer">Juicer</option>
              <option value="Core">Core</option>
              <option value="Supervisor">Supervisor</option>
              <option value="Freeosk">Freeosk</option>
              <option value="Digital">Digital</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
      </div>
      <div id="event-cards-container" class="event-cards">
        <!-- JavaScript will populate this -->
        <div class="loading-state" role="status" aria-live="polite">
          <div class="spinner"></div>
          <span class="sr-only">Loading events...</span>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Reschedule Event Modal -->
<div class="modal-backdrop" id="reschedule-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="reschedule-modal-title">
  <div class="action-modal" role="document">
    <header>
      <h2 id="reschedule-modal-title">Reschedule Event</h2>
      <button class="modal-close" aria-label="Close reschedule modal" data-action="close-reschedule-modal"><span aria-hidden="true">&times;</span></button>
    </header>
    <form id="reschedule-form">
      <input type="hidden" id="reschedule-schedule-id">
      <div class="form-group">
        <label id="reschedule-event-label">Event:</label>
        <div id="reschedule-event-info" aria-labelledby="reschedule-event-label"></div>
      </div>
      <div class="form-group">
        <label for="reschedule-date">New Date: <span class="required-indicator" aria-label="required">*</span></label>
        <input type="date" id="reschedule-date" required aria-required="true">
      </div>
      <div class="form-group">
        <label for="reschedule-time">New Time: <span class="required-indicator" aria-label="required">*</span></label>
        <input type="time" id="reschedule-time" required aria-required="true">
        <select id="reschedule-time-dropdown" class="hidden" aria-label="Select a time">
          <option value="">Select a time</option>
        </select>
      </div>
      <div class="form-group">
        <label for="reschedule-employee">Employee: <span class="required-indicator" aria-label="required">*</span></label>
        <select id="reschedule-employee" required aria-required="true">
          <option value="">Loading...</option>
        </select>
      </div>
      <div class="form-group" style="margin-top: 15px;">
        <label for="reschedule-override-constraints" aria-describedby="reschedule-override-help-text" style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
          <input type="checkbox" id="reschedule-override-constraints" name="override_constraints" value="true"
            style="width: auto; margin: 0;">
          <span style="font-weight: 500; color: #e67e22;">
            Override Scheduling Constraints
          </span>
        </label>
        <small id="reschedule-override-help-text" style="margin-left: 24px; color: #666; display: block; margin-top: 4px;">
          Enable to bypass role restrictions, time constraints, and one-Core-per-day limits.
        </small>
      </div>
      <footer class="modal-actions">
        <button type="button" class="btn btn-secondary"
          data-action="close-reschedule-modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Reschedule</button>
      </footer>
    </form>
  </div>
</div>

<!-- Reissue Event Modal -->
<div class="modal-backdrop" id="reissue-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="reissue-modal-title">
  <div class="action-modal" role="document">
    <header>
      <h3 id="reissue-modal-title">Reissue Event</h3>
      <button class="modal-close" aria-label="Close reissue modal" data-action="close-reissue-modal"><span aria-hidden="true">&times;</span></button>
    </header>
    <form id="reissue-form">
      <input type="hidden" id="reissue-schedule-id">
      <div class="form-group">
        <label id="reissue-event-label">Event:</label>
        <div id="reissue-event-info" aria-labelledby="reissue-event-label"></div>
      </div>
      <div class="form-group">
        <label for="reissue-date">New Date: <span class="required-indicator" aria-label="required">*</span></label>
        <input type="date" id="reissue-date" required aria-required="true">
      </div>
      <div class="form-group">
        <label for="reissue-time">New Time: <span class="required-indicator" aria-label="required">*</span></label>
        <input type="time" id="reissue-time" required aria-required="true">
      </div>
      <div class="form-group">
        <label for="reissue-employee">Employee: <span class="required-indicator" aria-label="required">*</span></label>
        <select id="reissue-employee" required aria-required="true">
          <option value="">Loading...</option>
        </select>
      </div>
      <div class="form-group" style="margin-top: 15px;">
        <label for="reissue-include-responses" aria-describedby="reissue-responses-help-text" style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
          <input type="checkbox" id="reissue-include-responses" name="include_responses" value="true"
            style="width: auto; margin: 0;">
          <span style="font-weight: 500;">
            Include Previous Responses
          </span>
        </label>
        <small id="reissue-responses-help-text" style="margin-left: 24px; color: #666; display: block; margin-top: 4px;">
          Enable to include responses from the original event submission.
        </small>
      </div>
      <footer class="modal-actions">
        <button type="button" class="btn btn-secondary"
          data-action="close-reissue-modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Reissue</button>
      </footer>
    </form>
  </div>
</div>

<!-- Bulk Reassign Supervisor Events Modal -->
<div class="modal-backdrop" id="bulk-reassign-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="bulk-reassign-modal-title">
  <div class="action-modal" role="document">
    <header>
      <h2 id="bulk-reassign-modal-title">Reassign All Supervisor Events</h2>
      <button class="modal-close" aria-label="Close reassign modal" data-action="close-bulk-reassign-modal"><span aria-hidden="true">&times;</span></button>
    </header>
    <form id="bulk-reassign-form">
      <div class="form-group">
        <label id="bulk-reassign-date-label">Date:</label>
        <div id="bulk-reassign-date-info" aria-labelledby="bulk-reassign-date-label">{{ selected_date.strftime('%A, %B %d, %Y') }}</div>
      </div>
      <div class="form-group">
        <label for="bulk-reassign-employee">Reassign all Supervisor events to: <span class="required-indicator" aria-label="required">*</span></label>
        <select id="bulk-reassign-employee" required aria-required="true">
          <option value="">Select an employee...</option>
          {% for employee in employees %}
          {% if employee.job_title in ['Club Supervisor', 'Lead Event Specialist'] %}
          <option value="{{ employee.id }}">{{ employee.name }} ({{ employee.job_title }})</option>
          {% endif %}
          {% endfor %}
        </select>
        <small class="form-help">Only Club Supervisors and Lead Event Specialists can work supervisor events</small>
      </div>
      <div class="form-group" style="margin-top: 15px;">
        <label for="bulk-reassign-override" style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
          <input type="checkbox" id="bulk-reassign-override" name="override_constraints" value="true"
            style="width: auto; margin: 0;">
          <span style="font-weight: 500; color: #e67e22;">
            Override Availability Constraints
          </span>
        </label>
        <small style="margin-left: 24px; color: #666; display: block; margin-top: 4px;">
          Enable to bypass weekly availability and time-off restrictions (use for exceptions).
        </small>
      </div>
      <div id="bulk-reassign-preview" class="form-group" style="display: none;">
        <label id="bulk-reassign-events-label">Events to reassign:</label>
        <div id="bulk-reassign-event-list" class="event-preview-list" aria-labelledby="bulk-reassign-events-label"></div>
      </div>
      <div id="bulk-reassign-error" class="error-message" style="display: none;"></div>
      <footer class="modal-actions">
        <button type="button" class="btn btn-secondary"
          data-action="close-bulk-reassign-modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Reassign All Events</button>
      </footer>
    </form>
  </div>
</div>

<!-- Change Event Type Modal -->
<div class="modal-backdrop" id="change-event-type-modal" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="change-type-modal-title">
  <div class="action-modal" role="document">
    <header>
      <h2 id="change-type-modal-title">Change Event Type</h2>
      <button class="modal-close" aria-label="Close change event type modal" data-action="close-change-event-type-modal"><span aria-hidden="true">&times;</span></button>
    </header>
    <form id="change-event-type-form" data-action-submit="submit-event-type-change">
      <input type="hidden" id="change-type-event-ref">
      <input type="hidden" id="change-type-schedule-id">

      <div class="form-group">
        <label id="change-type-event-label">Event:</label>
        <div id="change-type-event-info" style="font-weight: 600;" aria-labelledby="change-type-event-label"></div>
      </div>

      <div class="form-group">
        <label id="change-type-current-label">Current Type:</label>
        <div id="change-type-current" style="padding: 8px; background: #f0f0f0; border-radius: 4px;" aria-labelledby="change-type-current-label"></div>
      </div>

      <div class="form-group">
        <label for="change-type-new-type">New Event Type: <span class="required-indicator" aria-label="required">*</span></label>
        <select id="change-type-new-type" required aria-required="true">
          <option value="">Select event type...</option>
          <option value="Core">Core</option>
          <option value="Juicer Production">Juicer Production</option>
          <option value="Juicer Survey">Juicer Survey</option>
          <option value="Juicer Deep Clean">Juicer Deep Clean</option>
          <option value="Digital Setup">Digital Setup</option>
          <option value="Digital Refresh">Digital Refresh</option>
          <option value="Digital Teardown">Digital Teardown</option>
          <option value="Freeosk">Freeosk</option>
          <option value="Supervisor">Supervisor</option>
          <option value="Digitals">Digitals</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label for="change-type-reason">Reason (optional):</label>
        <textarea id="change-type-reason" rows="3" placeholder="Why is this event type being changed?"></textarea>
      </div>

      <div class="alert alert-info" style="margin-top: 15px; padding: 10px; background: #d1ecf1; border-radius: 4px;">
        <strong>Note:</strong> This change will persist through database refreshes. Existing employee assignment will remain.
      </div>

      <footer class="modal-actions">
        <button type="button" class="btn btn-secondary" data-action="close-change-event-type-modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Change Event Type</button>
      </footer>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load daily view JavaScript -->
<script src="{{ url_for('static', filename='js/pages/daily-view.js') }}?v={{ config.get('VERSION', '1.0') }}"
  defer></script>
<script>
document.addEventListener('click', function(e) {
    var target = e.target.closest('[data-action]');
    if (!target) return;
    var action = target.dataset.action;
    switch (action) {
        case 'close-reschedule-modal':
            window.dailyView.closeRescheduleModal();
            break;
        case 'close-reissue-modal':
            window.dailyView.closeReissueModal();
            break;
        case 'close-bulk-reassign-modal':
            window.dailyView.closeBulkReassignModal();
            break;
        case 'close-change-event-type-modal':
            window.dailyView.closeChangeEventTypeModal();
            break;
    }
});
document.addEventListener('submit', function(e) {
    var form = e.target.closest('[data-action-submit]');
    if (!form) return;
    if (form.dataset.actionSubmit === 'submit-event-type-change') {
        e.preventDefault();
        window.dailyView.submitEventTypeChange();
    }
});
</script>
{% endblock %}