{% extends "base.html" %}

{% block title %}Dashboard - Product Connections Scheduler{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_head %}
<!-- FLAW-003: Index page styles (extracted from embedded CSS) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/index.css') }}">
<!-- Epic 2 Story 2.2: Dashboard page styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/dashboard.css') }}">
<!-- Epic 2 Story 2.1: Schedule modal styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/schedule-modal.css') }}">
<!-- modal.css now loaded globally via base.html -->
{% endblock %}

{% block content %}
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
    </div>

    <!-- Welcome Section -->
    <div class="welcome-section">
        <div class="welcome-content">
            <h2 class="welcome-title">
                Welcome {% if supervisor_first_name %}{{ supervisor_first_name }}{% else %}Club Supervisor{% endif %}
            </h2>
            <p class="welcome-subtitle">{{ today.strftime('%A, %B %d, %Y') }}</p>

            <!-- Primary Lead and Juicer for Today -->
            <div class="role-display-container">
                <div class="role-card role-card--lead">
                    <div class="role-label">Primary Lead</div>
                    <div class="role-value role-value--lead">
                        {% if primary_lead_today %}{{ primary_lead_today }}{% else %}Not Scheduled{% endif %}
                    </div>
                </div>
                <div class="role-card role-card--juicer">
                    <div class="role-label">Juicer</div>
                    <div class="role-value role-value--juicer">
                        {% if juicer_today %}{{ juicer_today }}{% else %}Not Scheduled{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <section aria-labelledby="stats-heading">
        <h2 id="stats-heading" class="visually-hidden">Today's Statistics</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ total_core_today }}</div>
                <div class="stat-label">Core Events Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_digitals_today }}</div>
                <div class="stat-label">Digital Events Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ active_employees_count }}</div>
                <div class="stat-label">Active Employees</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ events_this_week }}</div>
                <div class="stat-label">Events This Week</div>
            </div>
        </div>
    </section>


    <!-- Main Dashboard Sections -->
    <div class="dashboard-sections">
        <!-- Schedule Verification Widget -->
        <section class="dashboard-section" id="verification-widget" aria-labelledby="verification-heading">
            <div class="section-header">
                <h3 class="section-title" id="verification-heading">
                    <span id="verification-widget-icon">üîç</span> Schedule Verification
                </h3>
            </div>

            <!-- Date Picker -->
            <div class="verification-date-row">
                <div class="verification-date-group">
                    <label for="verification-date" class="verification-date-label">Select Date to Verify:</label>
                    <input type="date" id="verification-date" class="form-control verification-date-input" value="{{ today.strftime('%Y-%m-%d') }}">
                </div>
                <button data-action="run-verification" class="btn btn-primary verification-btn">
                    Verify Schedule
                </button>
            </div>

            <!-- Verification Results -->
            <div id="verification-widget-results" class="verification-results">
                <!-- Status Badge -->
                <div id="verification-status-badge" class="verification-status-badge">
                    <!-- Dynamically populated -->
                </div>

                <!-- Critical Issues -->
                <div id="verification-critical-section" class="verification-results">
                    <h4 class="verification-section-heading verification-section-heading--critical">
                        <span class="verification-section-icon">üö®</span> Critical Issues
                    </h4>
                    <div id="verification-critical-list"></div>
                </div>

                <!-- Warnings -->
                <div id="verification-warnings-section" class="verification-results">
                    <h4 class="verification-section-heading verification-section-heading--warning">
                        <span class="verification-section-icon">‚ö†Ô∏è</span> Warnings
                    </h4>
                    <div id="verification-warnings-list"></div>
                </div>

                <!-- Info Messages -->
                <div id="verification-info-section" class="verification-results">
                    <h4 class="verification-section-heading verification-section-heading--info">
                        <span class="verification-section-icon">‚ÑπÔ∏è</span> Information
                    </h4>
                    <div id="verification-info-list"></div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="verification-widget-loading" class="verification-loading">
                <div class="verification-spinner"></div>
                <p class="verification-loading-text">Running verification...</p>
            </div>

            <!-- Initial State -->
            <div id="verification-widget-initial" class="verification-initial">
                <p>Select a date and click "Verify Schedule" to check for scheduling issues.</p>
            </div>
        </section>

        <!-- Today's Core Events -->
        <section class="dashboard-section" aria-labelledby="core-events-heading">
            <div class="section-header">
                <h3 class="section-title" id="core-events-heading">Today's Core Events</h3>
            </div>

            <!-- Core Time Slots with Employee Names -->
            <div class="time-slot-grid">
                <div class="time-slot">
                    <div class="time-slot-time">9:45 AM</div>
                    <div class="time-slot-employees">
                        {% for schedule, event, employee in today_core_events %}
                            {% if schedule.schedule_datetime.strftime('%H:%M') == '09:45' %}
                                <div class="time-slot-employee-name">{{ employee.name }}</div>
                            {% endif %}
                        {% endfor %}
                        {% if core_time_slots['9:45'] == 0 %}
                            <div class="time-slot-empty">None</div>
                        {% endif %}
                    </div>
                </div>
                <div class="time-slot">
                    <div class="time-slot-time">10:30 AM</div>
                    <div class="time-slot-employees">
                        {% for schedule, event, employee in today_core_events %}
                            {% if schedule.schedule_datetime.strftime('%H:%M') == '10:30' %}
                                <div class="time-slot-employee-name">{{ employee.name }}</div>
                            {% endif %}
                        {% endfor %}
                        {% if core_time_slots['10:30'] == 0 %}
                            <div class="time-slot-empty">None</div>
                        {% endif %}
                    </div>
                </div>
                <div class="time-slot">
                    <div class="time-slot-time">11:00 AM</div>
                    <div class="time-slot-employees">
                        {% for schedule, event, employee in today_core_events %}
                            {% if schedule.schedule_datetime.strftime('%H:%M') == '11:00' %}
                                <div class="time-slot-employee-name">{{ employee.name }}</div>
                            {% endif %}
                        {% endfor %}
                        {% if core_time_slots['11:00'] == 0 %}
                            <div class="time-slot-empty">None</div>
                        {% endif %}
                    </div>
                </div>
                <div class="time-slot">
                    <div class="time-slot-time">11:30 AM</div>
                    <div class="time-slot-employees">
                        {% for schedule, event, employee in today_core_events %}
                            {% if schedule.schedule_datetime.strftime('%H:%M') == '11:30' %}
                                <div class="time-slot-employee-name">{{ employee.name }}</div>
                            {% endif %}
                        {% endfor %}
                        {% if core_time_slots['11:30'] == 0 %}
                            <div class="time-slot-empty">None</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Core Events List (no scrollbar, clickable) -->
            {% if today_core_events %}
                <div class="core-events-list core-events-list--expanded">
                    {% for schedule, event, employee in today_core_events %}
                    <div class="core-event-item core-event-item--clickable" data-action="show-event-details" data-schedule-id="{{ schedule.id }}" data-ref-num="{{ event.project_ref_num }}" data-event-name="{{ event.project_name }}" data-employee-name="{{ employee.name if employee else 'Unassigned' }}" data-scheduled-date="{{ schedule.schedule_datetime.strftime('%m-%d-%Y') }}" data-scheduled-time="{{ schedule.schedule_datetime.strftime('%I:%M %p') }}" data-start-date="{{ event.start_datetime.strftime('%m-%d-%Y') }}" data-due-date="{{ event.due_datetime.strftime('%m-%d-%Y') }}" data-event-type="{{ event.event_type }}">
                        <div class="core-event-time">{{ schedule.schedule_datetime.strftime('%I:%M %p') }}</div>
                        <div class="core-event-employee">{{ employee.name if employee else 'Unassigned' }}</div>
                        <div class="core-event-name" title="{{ event.project_name }}">{{ event.project_name }}</div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-items">No Core events scheduled for today</div>
            {% endif %}

            <!-- Print Schedule Buttons -->
            <div class="print-schedule-section">
                <div class="print-controls">
                    <label for="schedule-date" class="print-controls__label">Select Date:</label>
                    <input type="date" id="schedule-date" class="form-control print-controls__input" value="{{ today.strftime('%Y-%m-%d') }}">
                    <button data-action="print-schedule" class="btn btn-primary">
                        Print Schedule
                    </button>
                </div>
            </div>

            <!-- Print Paperwork Buttons -->
            <div class="print-schedule-section">
                <div class="print-controls">
                    <label for="paperwork-date" class="print-controls__label">Select Date:</label>
                    <input type="date" id="paperwork-date" class="form-control print-controls__input" value="{{ today_date }}">
                    <button data-action="print-paperwork" class="btn btn-success">
                        Print Paperwork
                    </button>
                    <button data-action="print-sales-tools" class="btn btn-primary">
                        Print SalesTools
                    </button>
                    <button data-action="generate-edr" class="btn btn--navy">
                        Generate EDR Reports
                    </button>
                </div>
            </div>
        </section>

        <!-- Unscheduled Events & Scheduling Progress -->
        <section class="dashboard-section" aria-labelledby="scheduling-progress-heading">
            <div class="section-header">
                <h3 class="section-title" id="scheduling-progress-heading">Scheduling Progress (Next 2 Weeks)</h3>
            </div>

            <!-- Scheduling Percentage -->
            <div class="percentage-display">
                <div class="percentage-number">{{ scheduling_percentage }}%</div>
                <div class="percentage-label">
                    {{ scheduled_events_2weeks }} of {{ total_events_2weeks }} events scheduled
                </div>
            </div>

            <!-- Unscheduled Events (within 2 weeks) -->
            <h4 class="section-subtitle">
                Urgent Unscheduled Events ({{ unscheduled_events_2weeks|length }})
            </h4>
            
            {% if unscheduled_events_2weeks %}
                <div class="unscheduled-list">
                    {% for event in unscheduled_events_2weeks %}
                    <article class="unscheduled-item">
                        <div class="unscheduled-header">
                            <div class="unscheduled-title">{{ event.project_name }}</div>
                            <span class="event-type-badge event-type-{{ event.event_type.lower().replace(' ', '-') }}">
                                {{ event.event_type }}
                            </span>
                        </div>
                        <div class="unscheduled-dates">
                            üìÖ {{ event.start_datetime.strftime('%m/%d') }} - {{ event.due_datetime.strftime('%m/%d') }}
                        </div>

                        <!-- Schedule Now Button -->
                        <button class="btn btn-primary schedule-now-btn mt-sm w-full"
                                data-event-id="{{ event.project_ref_num }}"
                                data-event-name="{{ event.project_name }}"
                                data-event-type="{{ event.event_type }}"
                                data-location="{{ event.store_name or '' }}"
                                data-duration="{{ event.estimated_time or event.get_default_duration(event.event_type) }}"
                                data-date-needed="{{ event.start_datetime.strftime('%Y-%m-%d') }}">
                            <span class="btn-text">Schedule Now</span>
                            <span class="btn-spinner">‚è≥</span>
                        </button>
                    </article>
                    {% endfor %}
                </div>
                
                <div class="view-all-link">
                    <a href="{{ url_for('main.unscheduled_events') }}" class="btn btn-outline">
                        View All Unscheduled Events
                    </a>
                </div>
            {% else %}
                <div class="no-items">All events within 2 weeks are scheduled!</div>
            {% endif %}
        </section>

    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- MFA Authentication Modal -->
    <div id="mfa-modal" class="modal-overlay">
        <div class="mfa-modal-content">
            <h3 class="mfa-modal-title">EDR Authentication Required</h3>
            <p class="mfa-modal-description">
                Enter the MFA code sent to your phone to authenticate with Walmart Retail Link for EDR reports.
            </p>
            <div class="mfa-form-group">
                <label for="mfa-code-input" class="mfa-label">MFA Code</label>
                <input type="text"
                       id="mfa-code-input"
                       class="mfa-input"
                       placeholder="Enter 6-digit code"
                       maxlength="6">
            </div>
            <div id="mfa-error" class="mfa-error"></div>
            <div class="mfa-actions">
                <button data-action="cancel-mfa" class="btn btn-secondary">Cancel</button>
                <button data-action="submit-mfa" id="mfa-submit-btn" class="btn btn-primary">Authenticate</button>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div id="event-details-modal" class="modal-overlay modal-overlay--scrollable">
        <div class="event-details-modal-content">
            <div class="event-details-header">
                <h3 class="event-details-title">Event Details</h3>
                <button data-action="close-event-details" class="event-details-close">&times;</button>
            </div>

            <div id="event-details-content" class="event-details-content">
                <div class="event-details-grid">
                    <div class="event-details-label">Event Number:</div>
                    <div id="detail-event-number" class="event-details-value"></div>

                    <div class="event-details-label">Event Name:</div>
                    <div id="detail-event-name" class="event-details-value"></div>

                    <div class="event-details-label">Event Type:</div>
                    <div id="detail-event-type" class="event-details-value"></div>

                    <div class="event-details-label">Scheduled Employee:</div>
                    <div id="detail-employee" class="event-details-value event-details-value--highlight"></div>

                    <div class="event-details-label">Scheduled Date:</div>
                    <div id="detail-scheduled-date" class="event-details-value"></div>

                    <div class="event-details-label">Scheduled Time:</div>
                    <div id="detail-scheduled-time" class="event-details-value"></div>

                    <div class="event-details-label">Event Start Date:</div>
                    <div id="detail-start-date" class="event-details-value"></div>

                    <div class="event-details-label">Event Due Date:</div>
                    <div id="detail-due-date" class="event-details-value"></div>
                </div>
            </div>

            <div class="event-details-actions">
                <button data-action="reschedule-event" class="btn btn-primary">Reschedule</button>
                <button data-action="unschedule-event" class="btn btn-secondary">Unschedule</button>
                <button data-action="change-employee" class="btn btn-primary">Change Employee</button>
                <button data-action="print-edr" class="btn btn--navy">Print EDR</button>
                <button data-action="print-instructions" class="btn btn--blue">Print Instructions</button>
                <button data-action="print-both" class="btn btn-primary">Print Both</button>
            </div>

            <div class="event-details-footer">
                <button data-action="close-event-details" class="btn btn-outline">Close</button>
            </div>
        </div>
    </div>

    <!-- Reschedule Event Modal -->
    <div class="modal-backdrop modal-overlay modal-overlay--higher" id="reschedule-modal">
        <div class="action-modal">
            <button class="action-modal-close" data-action="close-modal" data-modal="reschedule-modal">&times;</button>
            <h3 class="action-modal-title">Reschedule Event</h3>
            <form id="reschedule-form">
                <input type="hidden" id="reschedule-schedule-id">
                <div class="form-group">
                    <label>Event:</label>
                    <div id="reschedule-event-info"></div>
                </div>
                <div class="form-group">
                    <label for="reschedule-date">New Date:</label>
                    <input type="date" id="reschedule-date" required>
                </div>
                <div class="form-group">
                    <label for="reschedule-time">New Time:</label>
                    <input type="time" id="reschedule-time" required>
                    <select id="reschedule-time-dropdown" class="hidden">
                        <option value="">Select a time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reschedule-employee">Employee:</label>
                    <select id="reschedule-employee" required>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal" data-modal="reschedule-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Reschedule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Employee Modal -->
    <div class="modal-backdrop modal-overlay modal-overlay--higher" id="change-employee-modal">
        <div class="action-modal">
            <button class="action-modal-close" data-action="close-modal" data-modal="change-employee-modal">&times;</button>
            <h3 class="action-modal-title">Change Employee</h3>
            <form id="change-employee-form">
                <input type="hidden" id="change-schedule-id">
                <div class="form-group">
                    <label>Event Details:</label>
                    <div id="change-event-info"></div>
                </div>
                <div class="form-group">
                    <label for="change-new-employee">New Employee:</label>
                    <select id="change-new-employee" required>
                        <option value="">Select new employee...</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal" data-modal="change-employee-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Employee</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<!-- Server-side data for index-page.js -->
<script type="application/json" id="page-data">
{
    "todayFormatted": {{ today.strftime('%A, %B %d, %Y') | tojson }},
    "tomorrowFormatted": {{ tomorrow.strftime('%A, %B %d, %Y') | tojson }},
    "todayCoreEvents": [
        {% for schedule, event, employee in today_core_events %}
        {
            "employee_name": {{ employee.name | tojson }},
            "time": {{ schedule.schedule_datetime.strftime('%I:%M %p') | tojson }},
            "event_name": {{ event.project_name | tojson }},
            "event_type": {{ event.event_type | tojson }}
        }{{ "," if not loop.last }}
        {% endfor %}
    ],
    "tomorrowCoreEvents": [
        {% for schedule, event, employee in tomorrow_core_events %}
        {
            "employee_name": {{ employee.name | tojson }},
            "time": {{ schedule.schedule_datetime.strftime('%I:%M %p') | tojson }},
            "event_name": {{ event.project_name | tojson }},
            "event_type": {{ event.event_type | tojson }}
        }{{ "," if not loop.last }}
        {% endfor %}
    ]
}
</script>

<!-- FLAW-003: Index page JavaScript (extracted from inline script) -->
<script src="{{ url_for('static', filename='js/pages/index-page.js') }}"></script>

<!-- Epic 2 Story 2.2: Dashboard page functionality -->
<script type="module" src="{{ url_for('static', filename='js/pages/dashboard.js') }}"></script>
{% endblock %}