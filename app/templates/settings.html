{#
  Template: settings.html
  Route: admin.settings (GET /admin/settings)

  Context variables:
    settings     (dict) - System settings keyed by setting name
    event_times  (dict) - Event start/end times keyed by "{type}_start_time"/"{type}_end_time"
#}
{% extends "base.html" %}

{% block title %}System Settings - Product Connections Scheduler{% endblock %}

{% block content %}
<div class="settings-container">
    <h2>System Settings</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <form id="settings-form" class="settings-form">
        <!-- Retail-Link Credentials Section -->
        <section class="settings-section">
            <h3>Walmart Retail-Link Credentials</h3>
            <p class="section-description">Configure Walmart Retail-Link EDR authentication credentials for paperwork
                printing</p>

            <div class="form-group">
                <label for="edr_username">EDR Username:</label>
                <input type="text" id="edr_username" name="edr_username" value="{{ settings.get('edr_username', '') }}"
                    class="form-control" placeholder="Enter EDR username" required>
            </div>

            <div class="form-group">
                <label for="edr_password">EDR Password:</label>
                <input type="password" id="edr_password" name="edr_password"
                    placeholder="{% if settings.get('edr_password') %}Leave blank to keep current{% else %}Enter password{% endif %}"
                    class="form-control" {% if not settings.get('edr_password') %}required{% endif %}>
                <small class="form-text">
                    {% if settings.get('edr_password') %}
                    Leave blank to keep current password
                    {% else %}
                    Enter your Walmart Retail Link password
                    {% endif %}
                </small>
            </div>

            <div class="form-group">
                <label for="edr_mfa_credential_id">MFA Credential ID:</label>
                <input type="text" id="edr_mfa_credential_id" name="edr_mfa_credential_id"
                    value="{{ settings.get('edr_mfa_credential_id', '') }}" class="form-control"
                    placeholder="Enter MFA credential ID" required>
                <small class="form-text">This is the unique ID for your MFA device (usually a phone number or device
                    ID)</small>
            </div>

            <div id="save-status" style="display: none; padding: 10px; margin-top: 15px; border-radius: 4px;"></div>
        </section>

        <!-- AI Assistant Configuration Section -->
        <section class="settings-section">
            <h3>AI Assistant Configuration</h3>
            <p class="section-description">Configure the AI provider and API credentials for the scheduling assistant
            </p>

            <div class="form-group">
                <label for="ai_provider">AI Provider:</label>
                <select id="ai_provider" name="ai_provider" class="form-control">
                    <option value="openai" {% if settings.get('ai_provider', 'openai' )=='openai' %}selected{% endif %}>
                        OpenAI (GPT-4/GPT-3.5)</option>
                    <option value="anthropic" {% if settings.get('ai_provider')=='anthropic' %}selected{% endif %}>
                        Anthropic (Claude)</option>
                    <option value="gemini" {% if settings.get('ai_provider')=='gemini' %}selected{% endif %}>Google
                        Gemini</option>
                </select>
                <small class="form-text">Select which AI provider to use for the scheduling assistant</small>
            </div>

            <div class="form-group">
                <label for="ai_api_key">API Key:</label>
                <input type="password" id="ai_api_key" name="ai_api_key"
                    placeholder="{% if settings.get('ai_api_key') %}‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢{% else %}Enter your API key{% endif %}"
                    class="form-control">
                <small class="form-text">
                    {% if settings.get('ai_api_key') %}
                    Leave blank to keep current API key. Get your API key from:
                    {% else %}
                    Enter your API key. Get it from:
                    {% endif %}
                    <a href="#" id="api-key-link" target="_blank" rel="noopener">provider website</a>
                </small>
            </div>

            <div id="ai-save-status" style="display: none; padding: 10px; margin-top: 15px; border-radius: 4px;"></div>
        </section>

        <!-- Store Closures Section -->
        <section class="settings-section" id="company-holidays">
            <h3>Store Closures</h3>
            <p class="section-description">Define days when the store is closed and no one is working (e.g., Christmas,
                Thanksgiving)</p>

            <div class="holiday-actions" style="margin-bottom: 15px;">
                <button type="button" id="add-holiday-btn" class="btn btn-primary btn-small">
                    <span>+</span> Add Store Closure
                </button>
            </div>

            <div id="holidays-list" class="holidays-list">
                <div class="loading-message">Loading store closures...</div>
            </div>

            <!-- Add/Edit Store Closure Modal -->
            <div id="holiday-modal" class="modal-overlay"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                <div class="modal-content"
                    style="max-width: 500px; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <div class="modal-header">
                        <h4 id="holiday-modal-title">Add Store Closure</h4>
                        <button type="button" class="modal-close" data-action="close-holiday-modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="holiday-id">

                        <div class="form-group">
                            <label for="holiday-name">Closure Name:</label>
                            <input type="text" id="holiday-name" class="form-control"
                                placeholder="e.g., Christmas Day, Store Renovation">
                        </div>

                        <div class="form-group">
                            <label for="holiday-date">Date:</label>
                            <input type="date" id="holiday-date" class="form-control">
                        </div>

                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="holiday-recurring">
                                <label for="holiday-recurring">Repeat every year on this date</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="holiday-notes">Notes (optional):</label>
                            <textarea id="holiday-notes" class="form-control" rows="2"
                                placeholder="Any additional notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-action="close-holiday-modal">Cancel</button>
                        <button type="button" class="btn btn-primary" data-action="save-holiday">Save</button>
                    </div>
                </div>
            </div>

            <div id="holiday-save-status" style="display: none; padding: 10px; margin-top: 15px; border-radius: 4px;">
            </div>
        </section>

        <!-- Paperwork Documentation Section -->
        <section class="settings-section" id="paperwork-templates">
            <h3>Paperwork Documentation</h3>
            <p class="section-description">Manage PDF templates for daily paperwork packages</p>

            <!-- Event-Level Documentation -->
            <div class="documentation-subsection">
                <h4>Event-Level Documentation</h4>
                <p class="subsection-description">These templates will be printed with each individual event (e.g.,
                    Event Detail Report)</p>

                <div class="template-actions">
                    <button type="button" id="add-event-template-btn" class="btn btn-primary btn-small">
                        <span>+</span> Add Event Template
                    </button>
                </div>

                <div id="event-templates-list" class="templates-list">
                    <div class="loading-message">Loading event templates...</div>
                </div>
            </div>

            <!-- Daily-Level Documentation -->
            <div class="documentation-subsection">
                <h4>Daily-Level Documentation</h4>
                <p class="subsection-description">These templates will be printed once after all event paperwork is
                    complete</p>

                <div class="template-actions">
                    <button type="button" id="add-daily-template-btn" class="btn btn-primary btn-small">
                        <span>+</span> Add Daily Template
                    </button>
                </div>

                <div id="daily-templates-list" class="templates-list">
                    <div class="loading-message">Loading daily templates...</div>
                </div>
            </div>
        </section>

        <!-- Event Time Settings Link -->
        <section class="settings-section" id="event-times-link">
            <h3>Event Time Settings</h3>
            <p class="section-description">Configure scheduling times for all event types including Freeosk, Digital Setup/Teardown, Supervisor, Core shift blocks, and more.</p>

            <a href="{{ url_for('admin.event_times_page') }}" class="btn btn-primary">
                Open Event Time Settings
            </a>
        </section>

        <!-- Auto-Scheduler Configuration Section -->
        <section class="settings-section" id="auto-scheduler-settings">
            <h3>Auto-Scheduler Configuration</h3>
            <p class="section-description">Configure which event types the auto-scheduler should process automatically</p>

            <div class="event-type-group">
                <fieldset style="border: none; padding: 0; margin: 0;">
                    <legend style="font-size: 1.1em; font-weight: bold; color: #2E4C73; margin-bottom: 15px; border-bottom: 2px solid #2E4C73; padding-bottom: 8px; display: block; width: 100%;">Enabled Event Types</legend>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                        Select which event types should be automatically scheduled. Unchecked types will require manual assignment.
                    </p>

                    <div class="event-type-toggles" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                        <div class="event-type-toggle-item">
                            <label class="toggle-container">
                                <input type="checkbox" id="auto_schedule_core" name="enabled_event_types" value="Core" checked>
                                <span class="toggle-label">Core Events</span>
                            </label>
                        </div>
                        <div class="event-type-toggle-item">
                            <label class="toggle-container">
                                <input type="checkbox" id="auto_schedule_juicer" name="enabled_event_types" value="Juicer" checked>
                                <span class="toggle-label">Juicer Events</span>
                            </label>
                        </div>
                        <div class="event-type-toggle-item">
                            <label class="toggle-container">
                                <input type="checkbox" id="auto_schedule_freeosk" name="enabled_event_types" value="Freeosk" checked>
                                <span class="toggle-label">Freeosk Events</span>
                            </label>
                        </div>
                        <div class="event-type-toggle-item">
                            <label class="toggle-container">
                                <input type="checkbox" id="auto_schedule_digital_setup" name="enabled_event_types" value="Digital Setup" checked>
                                <span class="toggle-label">Digital Setup</span>
                            </label>
                        </div>
                        <div class="event-type-toggle-item">
                            <label class="toggle-container">
                                <input type="checkbox" id="auto_schedule_digital_refresh" name="enabled_event_types" value="Digital Refresh" checked>
                                <span class="toggle-label">Digital Refresh</span>
                            </label>
                        </div>
                        <div class="event-type-toggle-item">
                            <label class="toggle-container">
                                <input type="checkbox" id="auto_schedule_digital_teardown" name="enabled_event_types" value="Digital Teardown" checked>
                                <span class="toggle-label">Digital Teardown</span>
                            </label>
                        </div>
                        <div class="event-type-toggle-item">
                            <label class="toggle-container">
                                <input type="checkbox" id="auto_schedule_supervisor" name="enabled_event_types" value="Supervisor" checked>
                                <span class="toggle-label">Supervisor Events</span>
                            </label>
                        </div>
                        <div class="event-type-toggle-item">
                            <label class="toggle-container">
                                <input type="checkbox" id="auto_schedule_other" name="enabled_event_types" value="Other" checked>
                                <span class="toggle-label">Other Events</span>
                            </label>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="event-type-group" style="margin-top: 20px;">
                <fieldset style="border: none; padding: 0; margin: 0;">
                    <legend style="font-size: 1.1em; font-weight: bold; color: #2E4C73; margin-bottom: 15px; border-bottom: 2px solid #2E4C73; padding-bottom: 8px; display: block; width: 100%;">Scheduling Options</legend>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label class="toggle-container">
                            <input type="checkbox" id="auto_schedule_on_import" name="auto_schedule_on_import">
                            <span class="toggle-label">Auto-schedule events when imported from Walmart</span>
                        </label>
                        <label class="toggle-container">
                            <input type="checkbox" id="require_approval" name="require_approval" checked>
                            <span class="toggle-label">Require approval before finalizing auto-scheduled assignments</span>
                        </label>
                    </div>
                </fieldset>
            </div>

            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" id="save-auto-scheduler-btn" class="btn btn-primary">Save Auto-Scheduler Settings</button>
            </div>

            <div id="auto-scheduler-save-status" style="display: none; padding: 10px; margin-top: 15px; border-radius: 4px;"></div>
        </section>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Settings</button>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<style>
    .settings-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .settings-section {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .settings-section h3 {
        color: #2E4C73;
        margin-top: 0;
        margin-bottom: 10px;
    }

    .section-description {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 20px;
    }

    .documentation-subsection {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 15px 20px;
        margin-bottom: 20px;
    }

    .documentation-subsection h4 {
        color: #2E4C73;
        margin: 0 0 8px 0;
        font-size: 1.05em;
        border-bottom: 2px solid #4A90D9;
        padding-bottom: 8px;
    }

    .subsection-description {
        color: #777;
        font-size: 0.85em;
        margin-bottom: 15px;
        font-style: italic;
    }

    .btn-small {
        padding: 6px 14px;
        font-size: 13px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .form-text {
        display: block;
        font-size: 0.85em;
        color: #666;
        margin-top: 5px;
    }

    .checkbox-group {
        display: flex;
        align-items: flex-start;
        flex-direction: column;
    }

    .checkbox-group input[type="checkbox"] {
        margin-right: 10px;
        margin-top: 3px;
    }

    .checkbox-group label {
        margin-bottom: 0;
        font-weight: normal;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }

    .btn-primary {
        background: #2E4C73;
        color: white;
    }

    .btn-primary:hover {
        background: #1a2f4a;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .flash-messages {
        margin-bottom: 20px;
    }

    .alert {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 10px;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .template-actions {
        margin-bottom: 15px;
    }

    .templates-list {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 100px;
    }

    .loading-message {
        text-align: center;
        padding: 40px;
        color: #666;
        font-style: italic;
    }

    .template-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        background: white;
        cursor: move;
    }

    .template-item:last-child {
        border-bottom: none;
    }

    .template-item:hover {
        background: #f9f9f9;
    }

    .template-item.dragging {
        opacity: 0.5;
    }

    .template-drag-handle {
        margin-right: 15px;
        cursor: move;
        color: #999;
        font-size: 20px;
    }

    .template-info {
        flex: 1;
    }

    .template-name {
        font-weight: bold;
        color: #2E4C73;
        margin-bottom: 4px;
    }

    .template-details {
        font-size: 0.85em;
        color: #666;
    }

    .template-actions-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .template-toggle {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .template-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .template-toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .template-toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    .template-toggle input:checked+.template-toggle-slider {
        background-color: #28a745;
    }

    .template-toggle input:checked+.template-toggle-slider:before {
        transform: translateX(26px);
    }

    .btn-delete-template {
        background: #dc3545;
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }

    .btn-delete-template:hover {
        background: #c82333;
    }

    .empty-templates {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    /* Event Time Configuration Styles */
    .warning-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 4px;
        padding: 12px 15px;
        margin-bottom: 20px;
        color: #856404;
    }

    .event-type-group {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .event-type-group h4 {
        color: #2E4C73;
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.1em;
        border-bottom: 2px solid #2E4C73;
        padding-bottom: 8px;
    }

    .time-slot-group {
        background: #f9f9f9;
        border: 1px solid #e8e8e8;
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 10px;
    }

    .time-slot-group:last-child {
        margin-bottom: 0;
    }

    .slot-label {
        display: block;
        font-weight: bold;
        color: #555;
        margin-bottom: 10px;
        font-size: 0.95em;
    }

    .time-input-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }

    .time-input {
        max-width: 150px;
    }

    .form-group label {
        font-size: 0.9em;
    }

    /* Auto-Scheduler Toggle Styles */
    .toggle-container {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 12px;
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .toggle-container:hover {
        background: #f0f0f0;
    }

    .toggle-container input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 10px;
        cursor: pointer;
    }

    .toggle-label {
        font-weight: normal;
        color: #333;
    }

    .event-type-toggle-item {
        margin: 0;
    }
</style>

<script>
    // Delegated click listener for all data-action buttons
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;

        switch (action) {
            case 'close-holiday-modal':
                if (window.closeHolidayModal) closeHolidayModal();
                break;
            case 'save-holiday':
                if (window.saveHoliday) saveHoliday();
                break;
            case 'edit-holiday':
                if (window.editHoliday) editHoliday(parseInt(target.dataset.holidayId));
                break;
            case 'delete-holiday':
                if (window.deleteHoliday) deleteHoliday(parseInt(target.dataset.holidayId), target.dataset.holidayName);
                break;
            case 'delete-template':
                if (window.deleteTemplate) deleteTemplate(parseInt(target.dataset.templateId));
                break;
        }
    });

    // Delegated change listener for data-action="toggle-template"
    document.addEventListener('change', function(e) {
        const target = e.target.closest('[data-action="toggle-template"]');
        if (!target) return;

        if (window.toggleTemplate) {
            toggleTemplate(parseInt(target.dataset.templateId), target.checked);
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('settings-form');
        const saveStatus = document.getElementById('save-status');
        const aiProviderSelect = document.getElementById('ai_provider');
        const apiKeyLink = document.getElementById('api-key-link');

        // Update API key link when provider changes
        function updateApiKeyLink() {
            const provider = aiProviderSelect.value;
            const links = {
                'openai': 'https://platform.openai.com/api-keys',
                'anthropic': 'https://console.anthropic.com/settings/keys',
                'gemini': 'https://aistudio.google.com/app/apikey'
            };
            apiKeyLink.href = links[provider] || '#';
        }

        aiProviderSelect.addEventListener('change', updateApiKeyLink);
        updateApiKeyLink(); // Initialize on page load

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('edr_username').value.trim();
            const password = document.getElementById('edr_password').value;
            const mfaCredentialId = document.getElementById('edr_mfa_credential_id').value.trim();
            const aiProvider = document.getElementById('ai_provider').value;
            const aiApiKey = document.getElementById('ai_api_key').value.trim();

            // Validation
            if (!username || !mfaCredentialId) {
                showStatus('Please fill in all required EDR fields', 'error');
                return;
            }

            // If password field is empty and there's already a saved password, skip password validation
            const passwordFieldPlaceholder = document.getElementById('edr_password').placeholder;
            if (!password && !passwordFieldPlaceholder.includes('Leave blank')) {
                showStatus('EDR password is required', 'error');
                return;
            }

            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                // Save EDR settings
                const edrResponse = await fetch('/api/settings/edr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password || undefined,
                        mfa_credential_id: mfaCredentialId
                    })
                });
                const edrData = await edrResponse.json();

                if (!edrData.success) {
                    showStatus('Error saving EDR settings: ' + (edrData.message || 'Failed'), 'error');
                    return;
                }

                // Save AI settings if provider or API key provided
                if (aiProvider || aiApiKey) {
                    const aiResponse = await fetch('/api/settings/ai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            provider: aiProvider,
                            api_key: aiApiKey || undefined
                        })
                    });
                    const aiData = await aiResponse.json();

                    if (!aiData.success) {
                        showStatus('EDR settings saved, but AI settings failed: ' + (aiData.message || 'Failed'), 'error');
                        return;
                    }
                }

                // Save Event Time settings (only if there are event time fields with values)
                const eventTimes = {};

                // Collect all event time inputs
                document.querySelectorAll('#event-times input[type="time"]').forEach(input => {
                    if (input.value) {
                        eventTimes[input.name] = input.value;
                    }
                });

                // Only save event times if there are values to save
                if (Object.keys(eventTimes).length > 0) {
                    const eventTimesResponse = await fetch('/api/settings/event-times', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(eventTimes)
                    });
                    const eventTimesData = await eventTimesResponse.json();

                    if (!eventTimesData.success) {
                        showStatus('Settings partially saved. Event time settings failed: ' + (eventTimesData.message || 'Failed'), 'error');
                        return;
                    }
                }

                // Success
                showStatus('All settings saved successfully!', 'success');

                // Clear password fields after successful save
                document.getElementById('edr_password').value = '';
                document.getElementById('edr_password').placeholder = 'Leave blank to keep current';

                if (aiApiKey) {
                    document.getElementById('ai_api_key').value = '';
                    document.getElementById('ai_api_key').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                }

            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        });

        function showStatus(message, type) {
            // Use toast notification instead of inline status div
            if (window.toaster) {
                if (type === 'success') {
                    window.toaster.success(message);
                } else {
                    window.toaster.error(message);
                }
            } else {
                console.error('[Settings] Toast notification system not available');
                // Fallback to alert if toaster not available
                alert(message);
            }
        }

        // ===== COMPANY HOLIDAYS MANAGEMENT =====
        const holidaysList = document.getElementById('holidays-list');
        const addHolidayBtn = document.getElementById('add-holiday-btn');
        let holidays = [];

        // Load holidays on page load
        loadHolidays();

        addHolidayBtn.addEventListener('click', function () {
            openHolidayModal();
        });

        function loadHolidays() {
            fetch('/api/company-holidays/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        holidays = data.holidays;
                        renderHolidays();
                    } else {
                        holidaysList.innerHTML = '<div class="empty-templates">Error loading store closures</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading store closures:', error);
                    holidaysList.innerHTML = '<div class="empty-templates">Error loading store closures</div>';
                });
        }

        function renderHolidays() {
            if (holidays.length === 0) {
                holidaysList.innerHTML = '<div class="empty-templates">No store closures defined. Add closures for days when no one should be scheduled.</div>';
                return;
            }

            // Sort by date
            const sortedHolidays = [...holidays].sort((a, b) => new Date(a.holiday_date) - new Date(b.holiday_date));

            holidaysList.innerHTML = sortedHolidays.map(holiday => {
                const dateObj = new Date(holiday.holiday_date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const recurringBadge = holiday.is_recurring
                    ? '<span class="badge badge-info" style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 8px;">Yearly</span>'
                    : '';

                const isPast = dateObj < new Date(new Date().setHours(0, 0, 0, 0));
                const pastClass = isPast ? 'style="opacity: 0.6;"' : '';

                return `
                <div class="template-item" ${pastClass} data-holiday-id="${holiday.id}">
                    <div class="template-info" style="flex: 1;">
                        <span class="template-name">${holiday.name}${recurringBadge}</span>
                        <span class="template-filename" style="color: #666; font-size: 12px;">${formattedDate}</span>
                        ${holiday.notes ? `<span class="template-filename" style="color: #888; font-size: 11px; font-style: italic;">${holiday.notes}</span>` : ''}
                    </div>
                    <div class="template-actions-inline">
                        <button type="button" class="btn btn-small btn-outline" data-action="edit-holiday" data-holiday-id="${holiday.id}" title="Edit">
                            ‚úèÔ∏è
                        </button>
                        <button type="button" class="btn btn-small btn-danger" data-action="delete-holiday" data-holiday-id="${holiday.id}" data-holiday-name="${holiday.name.replace(/"/g, '&quot;')}" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        window.openHolidayModal = function (holiday = null) {
            const modal = document.getElementById('holiday-modal');
            const title = document.getElementById('holiday-modal-title');
            const idField = document.getElementById('holiday-id');
            const nameField = document.getElementById('holiday-name');
            const dateField = document.getElementById('holiday-date');
            const recurringField = document.getElementById('holiday-recurring');
            const notesField = document.getElementById('holiday-notes');

            if (holiday) {
                title.textContent = 'Edit Store Closure';
                idField.value = holiday.id;
                nameField.value = holiday.name;
                dateField.value = holiday.holiday_date;
                recurringField.checked = holiday.is_recurring;
                notesField.value = holiday.notes || '';
            } else {
                title.textContent = 'Add Store Closure';
                idField.value = '';
                nameField.value = '';
                dateField.value = '';
                recurringField.checked = false;
                notesField.value = '';
            }

            modal.style.display = 'flex';
        };

        window.closeHolidayModal = function () {
            document.getElementById('holiday-modal').style.display = 'none';
        };

        window.editHoliday = function (holidayId) {
            const holiday = holidays.find(h => h.id === holidayId);
            if (holiday) {
                openHolidayModal(holiday);
            }
        };

        window.saveHoliday = function () {
            const idField = document.getElementById('holiday-id');
            const nameField = document.getElementById('holiday-name');
            const dateField = document.getElementById('holiday-date');
            const recurringField = document.getElementById('holiday-recurring');
            const notesField = document.getElementById('holiday-notes');

            const name = nameField.value.trim();
            const holidayDate = dateField.value;
            const isRecurring = recurringField.checked;
            const notes = notesField.value.trim();

            if (!name) {
                alert('Please enter a holiday name');
                return;
            }

            if (!holidayDate) {
                alert('Please select a date');
                return;
            }

            const data = {
                name: name,
                holiday_date: holidayDate,
                is_recurring: isRecurring,
                notes: notes || null
            };

            const holidayId = idField.value;
            const url = holidayId ? `/api/company-holidays/${holidayId}` : '/api/company-holidays/';
            const method = holidayId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeHolidayModal();
                        loadHolidays();
                        showHolidayStatus(data.message || 'Holiday saved successfully', 'success');
                    } else {
                        alert('Error: ' + (data.error || 'Failed to save holiday'));
                    }
                })
                .catch(error => {
                    console.error('Error saving holiday:', error);
                    alert('Error saving holiday: ' + error.message);
                });
        };

        window.deleteHoliday = function (holidayId, holidayName) {
            if (!confirm(`Are you sure you want to delete "${holidayName}"?`)) {
                return;
            }

            fetch(`/api/company-holidays/${holidayId}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadHolidays();
                        showHolidayStatus(data.message || 'Holiday deleted', 'success');
                    } else {
                        alert('Error: ' + (data.error || 'Failed to delete holiday'));
                    }
                })
                .catch(error => {
                    console.error('Error deleting holiday:', error);
                    alert('Error deleting holiday: ' + error.message);
                });
        };

        function showHolidayStatus(message, type) {
            // Use toast notification for consistency
            if (window.toaster) {
                if (type === 'success') {
                    window.toaster.success(message);
                } else {
                    window.toaster.error(message);
                }
            } else {
                console.error('[Settings] Toast notification system not available');
                // Fallback to alert if toaster not available
                alert(message);
            }
        }

        // ===== PAPERWORK TEMPLATES MANAGEMENT =====
        const eventTemplatesList = document.getElementById('event-templates-list');
        const dailyTemplatesList = document.getElementById('daily-templates-list');
        const addEventTemplateBtn = document.getElementById('add-event-template-btn');
        const addDailyTemplateBtn = document.getElementById('add-daily-template-btn');
        let eventTemplates = [];
        let dailyTemplates = [];
        let draggedElement = null;

        // Load templates on page load
        loadTemplates();

        function loadTemplates() {
            fetch('/api/paperwork-templates/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Separate templates by category
                        eventTemplates = data.templates.filter(t => t.category === 'event' || !t.category);
                        dailyTemplates = data.templates.filter(t => t.category === 'daily');
                        renderTemplates('event');
                        renderTemplates('daily');
                    } else {
                        eventTemplatesList.innerHTML = '<div class="empty-templates">Error loading templates</div>';
                        dailyTemplatesList.innerHTML = '<div class="empty-templates">Error loading templates</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading templates:', error);
                    eventTemplatesList.innerHTML = '<div class="empty-templates">Error loading templates</div>';
                    dailyTemplatesList.innerHTML = '<div class="empty-templates">Error loading templates</div>';
                });
        }

        function renderTemplates(category) {
            const templates = category === 'event' ? eventTemplates : dailyTemplates;
            const listElement = category === 'event' ? eventTemplatesList : dailyTemplatesList;
            const emptyMessage = category === 'event'
                ? 'No event templates. Add templates to include with each event report.'
                : 'No daily templates. Add templates to print after all events.';

            if (templates.length === 0) {
                listElement.innerHTML = `<div class="empty-templates">${emptyMessage}</div>`;
                return;
            }

            listElement.innerHTML = templates.map(template => `
            <div class="template-item" draggable="true" data-template-id="${template.id}" data-category="${category}">
                <span class="template-drag-handle">‚ò∞</span>
                <div class="template-info">
                    <div class="template-name">${escapeHtml(template.name)}</div>
                    <div class="template-details">
                        ${template.description ? escapeHtml(template.description) : 'No description'}
                    </div>
                </div>
                <div class="template-actions-group">
                    <label class="template-toggle">
                        <input type="checkbox" ${template.is_active ? 'checked' : ''}
                               data-action="toggle-template" data-template-id="${template.id}">
                        <span class="template-toggle-slider"></span>
                    </label>
                    <button type="button" class="btn-delete-template" data-action="delete-template" data-template-id="${template.id}">
                        Delete
                    </button>
                </div>
            </div>
        `).join('');

            // Add drag and drop event listeners
            const items = listElement.querySelectorAll('.template-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', (e) => handleDragEnd(e, category));
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Drag and Drop Handlers
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            if (this !== draggedElement) {
                const rect = this.getBoundingClientRect();
                const midpoint = rect.top + rect.height / 2;
                if (e.clientY < midpoint) {
                    this.parentNode.insertBefore(draggedElement, this);
                } else {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                }
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDragEnd(e, category) {
            this.classList.remove('dragging');

            // Get new order from the correct list
            const listElement = category === 'event' ? eventTemplatesList : dailyTemplatesList;
            const items = listElement.querySelectorAll('.template-item');
            const newOrder = Array.from(items).map(item => parseInt(item.dataset.templateId));

            // Save new order
            saveOrder(newOrder, category);
        }

        function saveOrder(templateIds, category) {
            fetch('/api/paperwork-templates/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ template_ids: templateIds, category: category })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Order saved successfully');
                        loadTemplates(); // Reload to get updated order
                    } else {
                        alert('Error saving order: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error saving order:', error);
                    alert('Error saving order');
                });
        }

        // Toggle Template Active Status
        window.toggleTemplate = function (templateId, isActive) {
            fetch(`/api/paperwork-templates/${templateId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ is_active: isActive })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Template status updated');
                    } else {
                        alert('Error updating template: ' + data.error);
                        loadTemplates(); // Reload to reset checkbox
                    }
                })
                .catch(error => {
                    console.error('Error updating template:', error);
                    alert('Error updating template');
                    loadTemplates(); // Reload to reset checkbox
                });
        };

        // Delete Template
        window.deleteTemplate = function (templateId) {
            // Search in both template arrays
            const template = eventTemplates.find(t => t.id === templateId) ||
                dailyTemplates.find(t => t.id === templateId);
            if (!template || !confirm(`Are you sure you want to delete "${template.name}"?`)) {
                return;
            }

            fetch(`/api/paperwork-templates/${templateId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTemplates();
                    } else {
                        alert('Error deleting template: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting template:', error);
                    alert('Error deleting template');
                });
        };

        // Add Template - shared handler for both event and daily categories
        function handleAddTemplate(category) {
            const btn = category === 'event' ? addEventTemplateBtn : addDailyTemplateBtn;
            const categoryLabel = category === 'event' ? 'Event' : 'Daily';

            // Create file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.style.display = 'none';

            fileInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    alert('Only PDF files are allowed');
                    return;
                }

                // Ask for template name (default to filename without extension)
                const defaultName = file.name.replace(/\.pdf$/i, '');
                const templateName = prompt(`Enter ${categoryLabel.toLowerCase()} template name:`, defaultName);

                if (!templateName) {
                    return; // User cancelled
                }

                // Ask for optional description
                const description = prompt('Enter description (optional):') || '';

                // Upload file
                const formData = new FormData();
                formData.append('file', file);
                formData.append('name', templateName);
                formData.append('description', description);
                formData.append('category', category);

                // Show uploading state
                btn.disabled = true;
                btn.textContent = 'Uploading...';

                fetch('/api/paperwork-templates/upload', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: formData
                })
                    .then(response => response.json().then(data => ({ status: response.status, data })))
                    .then(({ status, data }) => {
                        if (data.success) {
                            alert(`${categoryLabel} template uploaded successfully!`);
                            loadTemplates();
                        } else if (data.conflict) {
                            // File already exists - ask to overwrite
                            if (confirm(data.message + '\n\nClick OK to overwrite, Cancel to abort.')) {
                                // Retry with overwrite flag
                                formData.append('overwrite', 'true');
                                return fetch('/api/paperwork-templates/upload', {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': getCsrfToken()
                                    },
                                    body: formData
                                })
                                    .then(r => r.json())
                                    .then(retryData => {
                                        if (retryData.success) {
                                            alert(`${categoryLabel} template ${retryData.overwritten ? 'overwritten' : 'uploaded'} successfully!`);
                                            loadTemplates();
                                        } else {
                                            alert('Error uploading template: ' + (retryData.error || 'Unknown error'));
                                        }
                                    });
                            }
                        } else {
                            alert('Error uploading template: ' + (data.error || data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Error uploading template:', error);
                        alert('Error uploading template: ' + error.message);
                    })
                    .finally(() => {
                        btn.disabled = false;
                        btn.innerHTML = `<span>+</span> Add ${categoryLabel} Template`;
                    });
            });

            // Trigger file selection
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // Event handlers for both add buttons
        addEventTemplateBtn.addEventListener('click', () => handleAddTemplate('event'));
        addDailyTemplateBtn.addEventListener('click', () => handleAddTemplate('daily'));

        // Helper function to get CSRF token
        function getCsrfToken() {
            const token = document.cookie.split('; ')
                .find(row => row.startsWith('csrf_token='))
                ?.split('=')[1];
            return token || '';
        }

        // ===== Auto-Scheduler Settings =====
        const autoSchedulerSaveStatus = document.getElementById('auto-scheduler-save-status');
        const saveAutoSchedulerBtn = document.getElementById('save-auto-scheduler-btn');

        // Load auto-scheduler settings on page load
        async function loadAutoSchedulerSettings() {
            try {
                const response = await fetch('/api/auto-scheduler/settings');
                const data = await response.json();

                if (data.success && data.settings) {
                    const settings = data.settings;

                    // Set enabled event types
                    const allEventTypes = ['Core', 'Juicer', 'Freeosk', 'Digital Setup', 'Digital Refresh', 'Digital Teardown', 'Supervisor', 'Other'];
                    const enabledTypes = settings.enabled_event_types || allEventTypes;

                    allEventTypes.forEach(type => {
                        const checkbox = document.getElementById('auto_schedule_' + type.toLowerCase());
                        if (checkbox) {
                            checkbox.checked = enabledTypes.includes(type);
                        }
                    });

                    // Set other options
                    const autoScheduleOnImport = document.getElementById('auto_schedule_on_import');
                    const requireApproval = document.getElementById('require_approval');

                    if (autoScheduleOnImport) {
                        autoScheduleOnImport.checked = settings.auto_schedule_on_import || false;
                    }
                    if (requireApproval) {
                        requireApproval.checked = settings.require_approval !== false;
                    }
                }
            } catch (error) {
                console.error('Error loading auto-scheduler settings:', error);
            }
        }

        // Save auto-scheduler settings
        async function saveAutoSchedulerSettings() {
            const enabledTypes = [];
            const allEventTypes = ['Core', 'Juicer', 'Freeosk', 'Digital Setup', 'Digital Refresh', 'Digital Teardown', 'Supervisor', 'Other'];

            allEventTypes.forEach(type => {
                const checkbox = document.getElementById('auto_schedule_' + type.toLowerCase());
                if (checkbox && checkbox.checked) {
                    enabledTypes.push(type);
                }
            });

            const autoScheduleOnImport = document.getElementById('auto_schedule_on_import');
            const requireApproval = document.getElementById('require_approval');

            const settings = {
                enabled_event_types: enabledTypes,
                auto_schedule_on_import: autoScheduleOnImport ? autoScheduleOnImport.checked : false,
                require_approval: requireApproval ? requireApproval.checked : true
            };

            try {
                saveAutoSchedulerBtn.disabled = true;
                saveAutoSchedulerBtn.textContent = 'Saving...';

                const response = await fetch('/api/auto-scheduler/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    showAutoSchedulerStatus('Auto-scheduler settings saved successfully!', 'success');
                } else {
                    showAutoSchedulerStatus('Error: ' + (data.error || 'Failed to save settings'), 'error');
                }
            } catch (error) {
                console.error('Error saving auto-scheduler settings:', error);
                showAutoSchedulerStatus('Error saving settings. Please try again.', 'error');
            } finally {
                saveAutoSchedulerBtn.disabled = false;
                saveAutoSchedulerBtn.textContent = 'Save Auto-Scheduler Settings';
            }
        }

        function showAutoSchedulerStatus(message, type) {
            autoSchedulerSaveStatus.textContent = message;
            autoSchedulerSaveStatus.style.display = 'block';
            autoSchedulerSaveStatus.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            autoSchedulerSaveStatus.style.color = type === 'success' ? '#155724' : '#721c24';
            autoSchedulerSaveStatus.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';

            setTimeout(() => {
                autoSchedulerSaveStatus.style.display = 'none';
            }, 5000);
        }

        // Initialize auto-scheduler settings
        if (saveAutoSchedulerBtn) {
            saveAutoSchedulerBtn.addEventListener('click', saveAutoSchedulerSettings);
            loadAutoSchedulerSettings();
        }
    });
</script>
{% endblock %}